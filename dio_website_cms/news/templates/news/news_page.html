{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
<article class="w-full">
    <!-- Hero Section -->
    <section class="section is-secondary relative min-h-[700px] lg:min-h-[700px] flex items-center overflow-hidden">
        {% if page.image %}
            {% image page.image original as bg_image %}
            <div class="absolute inset-0 z-0">
                <img src="{{ bg_image.url }}" alt="{{ page.headline }}" class="w-full h-full object-cover">
                <div class="absolute inset-0 bg-black/40"></div>
            </div>
        {% endif %}
        <div class="container mx-auto px-4 lg:px-8  relative z-10">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center">
                <div class="space-y-6">
                    <span class="inline-block px-4 py-2 rounded-full bg-red-600/80 text-red-100 text-sm font-semibold">
                        {{ page.get_category_display }}
                    </span>
                    <h1 class="heading_h1 text-4xl lg:text-5xl font-bold leading-tight text-white drop-shadow-md">
                        {{ page.headline }}
                    </h1>
                    <p class="heading_h3 text-lg lg:text-xl leading-relaxed text-white/90 max-w-prose">
                        {{ page.intro|striptags }}
                    </p>
                    <div>
                        <a href="/news" style="color:rgb(255, 255, 255); box-shadow: 0 0 0 2px #ffffff inset" class="button is-secondary w-button inline-block px-6 py-3 rounded-lg shadow-lg hover:bg-red-50 hover:shadow-xl">
                            Все новости
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <section class="section">
        <div class="heading_h3 container mx-auto px-4 lg:px-8 ">
            <div class="prose prose-lg max-w-none news-content">
                {{ page.content|richtext }}
            </div>
        </div>
    </section>

    <!-- Modern Gallery Carousel -->
    {% if page.gallery %}
    <section class="section is-secondary">
        <div class="container mx-auto px-4 lg:px-8 ">
            <div class="header is-align-center mb-12">
                <h2 class="heading_h2">Галерея</h2>
            </div>
            
            <!-- Карусель -->
            <div class="relative">
                <div class="gallery-carousel overflow-hidden">
                    <div class="flex gap-6 pb-4 overflow-x-auto scrollbar-hide snap-x snap-mandatory">
                        {% for item in page.gallery %}
                        {% image item.value.image fill-400x300 as gallery_image %}
                        <div class="flex-shrink-0 w-80 snap-start">
                            <div class="gallery-card cursor-pointer group" onclick="openFullscreenModal({{ forloop.counter0 }})">
                                <div class="image-ratio_4x3 rounded-xl overflow-hidden mb-4">
                                    <img src="{{ gallery_image.url }}" alt="" 
                                         class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                                    <div class="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-all duration-300"></div>
                                </div>
                                {% if item.value.caption %}
                                <div class="text-center">
                                    <p class="text-gray-600 text-sm line-clamp-2">{{ item.value.caption|striptags }}</p>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Индикатор прокрутки -->
                <div class="flex justify-center mt-6 space-x-2">
                    {% for item in page.gallery %}
                    <div class="w-2 h-2 bg-gray-300 rounded-full transition-all duration-300 indicator-dot"></div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Other News -->
    {% if other_news %}
    <section class="section is-secondary">
        <div class="container mx-auto px-4 lg:px-8 ">
            <div class="header is-align-center">
                <h2 class="heading_h2">Другие новости</h2>
            </div>
            <div class="w-layout-grid grid_3-col tablet-1-col gap-large mt-12">
                {% for news in other_news %}
                <article class="card on-secondary">
                    <a href="{% pageurl news %}">
                        {% if news.image %}
                        <div class="image-ratio_16x9">
                            {% image news.image fill-400x225 class="image_cover" %}
                        </div>
                        {% endif %}
                    </a>
                    <div class="card_body space-y-4 p-6">
                        <span class="inline-block px-3 py-1 bg-red-50 text-red-700 heading_h5 rounded-full">
                            {{ news.get_category_display }}
                        </span>
                        <h3 class="heading_h4  ">
                            <a href="{% pageurl news %}" class="hover:text-red-600">{{ news.headline }}</a>
                        </h3>
                        <div class="flex items-center justify-between ">
                            <span>{{ news.date|date:"d.m.Y" }}</span>
                            <span>{{ news.read_time }} мин</span>
                        </div>
                    </div>
                </article>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
</article>

<!-- Fullscreen Modal -->
<div id="fullscreenModal" class="fixed inset-0 z-[9999] hidden bg-black">
    <div class="relative w-full h-full flex items-center justify-center">
        <!-- Кнопка закрытия -->
        <button onclick="closeFullscreenModal()" 
                class="absolute top-6 right-6 z-50 text-white text-3xl hover:text-red-400 bg-black/50 rounded-full w-12 h-12 flex items-center justify-center transition-all duration-300 hover:bg-black/70">
            ✕
        </button>
        
        <!-- Кнопка назад -->
        <button onclick="prevFullscreenImage()" 
                class="absolute left-6 z-50 text-white text-3xl hover:text-red-400 bg-black/50 rounded-full w-12 h-12 flex items-center justify-center transition-all duration-300 hover:bg-black/70 lg:left-8">
            ‹
        </button>
        
        <!-- Кнопка вперед -->
        <button onclick="nextFullscreenImage()" 
                class="absolute right-6 z-50 text-white text-3xl hover:text-red-400 bg-black/50 rounded-full w-12 h-12 flex items-center justify-center transition-all duration-300 hover:bg-black/70 lg:right-8">
            ›
        </button>
        
        <!-- Контент по центру -->
        <div class="relative w-full h-full flex flex-col items-center justify-center p-4">
            <div class="max-w-6xl max-h-[85vh] w-full h-full flex items-center justify-center">
                <img id="fullscreenImage" src="" alt="" 
                     class="max-w-full max-h-full object-contain rounded-lg">
            </div>
            
            <!-- Капшен и счетчик -->
            <div class="absolute bottom-8 left-1/2 transform -translate-x-1/2 text-center text-white">
                <div id="fullscreenCaption" class="text-lg mb-2 max-w-2xl px-4"></div>
                <div class="text-sm opacity-80">
                    <span id="fullscreenCurrent">1</span> / <span id="fullscreenTotal">{{ page.gallery|length }}</span>
                </div>
            </div>
        </div>
        
        <!-- Миниатюры внизу -->
        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2">
            <div class="flex gap-2  overflow-x-auto px-4 py-2 scrollbar-hide">
                {% for item in page.gallery %}
                {% image item.value.image fill-80x60 as thumb %}
                <img src="{{ thumb.url }}" 
                     alt=""
                     class="w-16 h-12 object-cover rounded cursor-pointer opacity-60 hover:opacity-100 transition-opacity duration-200 border-2 border-transparent thumbnail"
                     onclick="goToFullscreenImage({{ forloop.counter0 }})">
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для карусели */
.gallery-carousel::-webkit-scrollbar {
    display: none;
}
.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.image-ratio_4x3 {
    aspect-ratio: 4/3;
    position: relative;
    overflow: hidden;
    border-radius: 0.75rem;
}

.image-ratio_16x9 {
    aspect-ratio: 16/9;
    position: relative;
    overflow: hidden;
    border-radius: 0.75rem;
}

.image-ratio_4x3 img,
.image-ratio_16x9 img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Карточка галереи */
.gallery-card {
    transition: all 0.3s ease;
}

.gallery-card:hover {
    transform: translateY(-8px);
}

/* Индикаторы карусели */
.indicator-dot.active {
    background: #ef4444;
    width: 16px;
    border-radius: 8px;
}

/* Анимации */
@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

.fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Адаптивность */
@media (max-width: 768px) {
    .gallery-carousel .flex > div {
        width: 280px;
    }
    
    #fullscreenModal button {
        width: 44px;
        height: 44px;
        font-size: 24px;
    }
    
    #fullscreenModal .absolute.left-6 {
        left: 16px;
    }
    
    #fullscreenModal .absolute.right-6 {
        right: 16px;
    }
    
    #fullscreenModal .absolute.top-6 {
        top: 16px;
    }
}

.w-layout-grid.grid_3-col { 
    display: grid; 
    grid-template-columns: repeat(3, 1fr); 
    gap: 2rem; 
}

@media (max-width: 1024px) { 
    .w-layout-grid.grid_3-col { 
        grid-template-columns: repeat(2, 1fr); 
    } 
}

@media (max-width: 640px) { 
    .w-layout-grid.grid_3-col { 
        grid-template-columns: 1fr; 
    } 
}






.line-clamp-2 {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 2;
    overflow: hidden;
}

/* Prose стили */
.prose h2 { color: #111827 !important; font-weight: 700 !important; font-size: 2rem !important; margin: 2rem 0 1rem !important; }
.prose h3 { color: #111827 !important; font-weight: 600 !important; font-size: 1.5rem !important; margin: 1.5rem 0 0.75rem !important; }
.prose p { line-height: 1.75 !important; margin-bottom: 1.25rem !important; }
.prose ul, .prose ol { margin-bottom: 1.25rem !important; padding-left: 2rem !important; }
.prose ul li, .prose ol li { margin-bottom: 0.5rem !important; padding-left: 0.5rem !important; }
.prose blockquote { color: #374151 !important; font-style: italic !important; border-left: 4px solid #ef4444 !important; padding-left: 1rem !important; margin: 1.5rem 0 !important; background: #fef2f2 !important; padding: 1rem !important; border-radius: 0.5rem !important; }
.prose a { color: #ef4444 !important; text-decoration: underline !important; }
.prose a:hover { color: #dc2626 !important; }
</style>

<script>
let currentFullscreenIndex = 0;
const galleryItems = [];
let touchStartX = 0;

// Инициализация галереи
document.addEventListener('DOMContentLoaded', function() {
    {% if page.gallery %}
        {% for item in page.gallery %}
            {% image item.value.image original as gallery_image %}
            galleryItems.push({
                image: '{{ gallery_image.url }}',
                caption: `{{ item.value.caption|richtext|escapejs }}`
            });
        {% endfor %}
    {% endif %}
    
    initCarousel();
});

// Карусель с индикаторами
function initCarousel() {
    const carousel = document.querySelector('.gallery-carousel .flex');
    const indicators = document.querySelectorAll('.indicator-dot');
    
    if (carousel && indicators.length > 0) {
        carousel.addEventListener('scroll', () => {
            const scrollPos = carousel.scrollLeft;
            const itemWidth = carousel.querySelector('div').offsetWidth + 24; // width + gap
            const activeIndex = Math.round(scrollPos / itemWidth);
            
            indicators.forEach((dot, index) => {
                dot.classList.toggle('active', index === activeIndex);
            });
        });
    }
}

// Полноэкранный режим
function openFullscreenModal(index) {
    currentFullscreenIndex = index;
    updateFullscreenModal();
    const modal = document.getElementById('fullscreenModal');
    modal.classList.remove('hidden');
    modal.classList.add('fade-in');
    document.body.style.overflow = 'hidden';
    document.documentElement.style.overflow = 'hidden';
    updateThumbnails();
}

function closeFullscreenModal() {
    const modal = document.getElementById('fullscreenModal');
    modal.classList.add('hidden');
    modal.classList.remove('fade-in');
    document.body.style.overflow = 'auto';
    document.documentElement.style.overflow = 'auto';
}

function prevFullscreenImage() {
    currentFullscreenIndex = (currentFullscreenIndex - 1 + galleryItems.length) % galleryItems.length;
    updateFullscreenModal();
}

function nextFullscreenImage() {
    currentFullscreenIndex = (currentFullscreenIndex + 1) % galleryItems.length;
    updateFullscreenModal();
}

function goToFullscreenImage(index) {
    currentFullscreenIndex = index;
    updateFullscreenModal();
}

function updateFullscreenModal() {
    document.getElementById('fullscreenImage').src = galleryItems[currentFullscreenIndex].image;
    document.getElementById('fullscreenCaption').innerHTML = galleryItems[currentFullscreenIndex].caption || '';
    document.getElementById('fullscreenCurrent').textContent = currentFullscreenIndex + 1;
    document.getElementById('fullscreenTotal').textContent = galleryItems.length;
    updateThumbnails();
}

function updateThumbnails() {
    document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
        thumb.classList.toggle('border-red-500', index === currentFullscreenIndex);
        thumb.classList.toggle('opacity-100', index === currentFullscreenIndex);
        thumb.classList.toggle('opacity-60', index !== currentFullscreenIndex);
    });
}

// Свайпы для мобильных
document.getElementById('fullscreenModal').addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
});

document.getElementById('fullscreenModal').addEventListener('touchend', function(e) {
    const touchEndX = e.changedTouches[0].screenX;
    const diff = touchStartX - touchEndX;
    const swipeThreshold = 50;
    
    if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
            nextFullscreenImage();
        } else {
            prevFullscreenImage();
        }
    }
});

// Управление клавиатурой
document.addEventListener('keydown', (e) => {
    if (!document.getElementById('fullscreenModal').classList.contains('hidden')) {
        if (e.key === 'Escape') closeFullscreenModal();
        if (e.key === 'ArrowLeft') prevFullscreenImage();
        if (e.key === 'ArrowRight') nextFullscreenImage();
        if (e.key >= '1' && e.key <= '9') {
            const num = parseInt(e.key) - 1;
            if (num < galleryItems.length) goToFullscreenImage(num);
        }
    }
});
</script>
{% endblock %}