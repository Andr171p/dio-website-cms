{% load wagtailcore_tags wagtailimages_tags static %}

<!-- Hero с чатом -->
<section id="hero-chat" class="hero-chat relative">
  <div class="container">
    <!-- Заголовок и подзаголовок -->
    <div class="hero-text text-center">
      <h1 class="heading_h1">AI-Алёша</h1>
      <p class="hero-subtitle heading_h4">Ваш AI-помощник Алёша всегда на связи. Задайте вопрос и получите быстрый ответ прямо здесь.</p>
    </div>
    <!-- Чат -->
    <div class="chat-widget" id="chatWidget">
      <div class="chat-header" id="chatHeader">
        <h2 class="heading_h2">Алёша</h2>
        <span class="chat-hint animate-pulse hidden">Спросите Алёшу</span>
      </div>
      <div class="chat-messages-container" id="chatMessagesContainer">
        <div class="chat-messages" id="chatMessages">
          <!-- Начальное сообщение бота (опционально, можно убрать) -->
          <!-- <div class="message bot-message1">Здравствуйте! Чем могу помочь?</div> -->
        </div>
        <!-- Большое поле ввода в центре -->
        <div class="initial-input-container" id="initialInputContainer">
          <input type="text" id="initialChatInput" placeholder="Задайте свой вопрос..." aria-label="Введите первый вопрос">
          <button id="initialSendButton" aria-label="Отправить сообщение">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#fff"/>
            </svg>
          </button>
        </div>
      </div>
      <!-- Стандартное поле ввода (скрыто по умолчанию) -->
      <div class="chat-input-container hidden" id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="С чем вам помочь?" aria-label="Введите сообщение">
        <button id="sendButton" aria-label="Отправить сообщение">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#fff"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</section>

<style>
/* --- Hero --- */
.hero-chat {
  background: linear-gradient(135deg, #151515 25%, #e6e6e6 100%);
  padding: 60px 20px 100px;
  position: relative;
  overflow: hidden;
}
.container {
  max-width: 1200px;
  margin: 0 auto;
}
.hero-text {
  margin-bottom: 48px;
}
.hero-text h1 {
  font-size: 52px;
  font-weight: 700;
  color: #ffffff;
  letter-spacing: -0.02em;
  margin-bottom: 16px;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
}
.hero-subtitle {
  font-size: 22px;
  line-height: 1.6;
  color: #ffffff;
  max-width: 600px;
  margin: 0 auto;
  opacity: 0.9;
}

/* --- Чат --- */
.chat-widget {
  background: #2e2e2e; /* Темно-серый фон */
  border-radius: 16px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  animation: pulseBorder 2s infinite ease-in-out;
  max-width: 1200px;
  width: 100%;
  height: 520px;
}

.chat-header {
  background: #2e2e2e; /* Темно-серый, совпадает с фоном */
  color: #ffffff;
  padding: 16px 20px;
  display: flex;
  align-items: center;
  gap: 12px;
  border-bottom: 1px solid #404040; /* Светлее серый для разделения */
}
.chat-header h2 {
  font-size: 20px;
  font-weight: 600;
  margin: 0;
  letter-spacing: 0.5px;
}
.chat-hint {
  font-size: 14px;
  color: #ffffff;
  opacity: 0.7;
  transition: opacity 0.3s ease;
}
.chat-hint:hover {
  opacity: 1;
}

.chat-messages-container {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
  background: #2e2e2e; /* Совпадает с фоном чата */
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
}
.chat-messages {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
.message {
  padding: 12px 16px;
  border-radius: 12px;
  font-size: 14px;
  line-height: 1.4;
  max-width: 80%;
  animation: fadeInUp 0.4s ease-out;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
.bot-message1 {
  background: #404040; /* Светло-серый для бота, близкий к фону */
  color: #ffffff;
  align-self: flex-start;
}
.user-message1 {
  background: #4a4a4a; /* Чуть светлее серый для пользователя */
  color: #ffffff;
  align-self: flex-end;
}

/* --- Начальное большое поле ввода --- */
.initial-input-container {
  display: flex;
  align-items: center;
  justify-content: center;
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 95%;
  max-width: 1000px;
  background: #2e2e2e; /* Совпадает с фоном чата */
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
}
.initial-input-container input {
  flex: 1;
  padding: 30px;
  border: none;
  outline: none;
  font-size: 28px;
  color: #ffffff;
  background: transparent;
  border-bottom: 2px solid #404040; /* Светлее серый для контура */
  transition: border-color 0.3s ease;
}
.initial-input-container input::placeholder {
  color: #757575; /* Средне-серый для placeholder */
  font-style: italic;
  opacity: 0.8;
}
.initial-input-container input:focus,
.initial-input-container input:hover {
  border-color: #4a4a4a; /* Чуть светлее при фокусе */
}
.initial-input-container button {
  background: #404040; /* Светлее серый для кнопки */
  color: #ffffff;
  border: none;
  padding: 12px;
  width: 48px;
  height: 48px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 10px rgba(64, 64, 64, 0.4);
}
.initial-input-container button:hover {
  background: #4a4a4a; /* Чуть светлее при наведении */
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(64, 64, 64, 0.6);
}

/* --- Стандартное поле ввода --- */
.chat-input-container {
  display: flex;
  max-height: 50px;
  background: #2e2e2e; /* Совпадает с фоном чата */
  border-radius: 0 0 12px 12px;
  overflow: hidden;
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.2);
}
.chat-input-container input {
  flex: 1;
  padding: 12px;
  border: none;
  outline: none;
  font-size: 14px;
  color: #ffffff;
  background: transparent;
  border-bottom: 2px solid #404040; /* Светлее серый для контура */
  transition: border-color 0.3s ease;
}
.chat-input-container input::placeholder {
  color: #757575; /* Средне-серый для placeholder */
  opacity: 0.7;
}
.chat-input-container input:focus,
.chat-input-container input:hover {
  border-color: #4a4a4a; /* Чуть светлее при фокусе */
}
.chat-input-container button {
  background: #404040; /* Светлее серый для кнопки */
  color: #ffffff;
  border: none;
  padding: 8px;
  width: 32px;
  height: 32px;
  cursor: pointer;
  transition: all 0.3s ease;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 8px;
  box-shadow: 0 2px 6px rgba(64, 64, 64, 0.4);
}
.chat-input-container button:hover {
  background: #4a4a4a; /* Чуть светлее при наведении */
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(64, 64, 64, 0.6);
}
@keyframes pulseButton {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Скрытие элементов */
.hidden {
  display: none !important;
}

/* Стили для эффекта пишущей машинки */
.initial-input-container input,
.chat-input-container input {
  position: relative;
}
.initial-input-container input::after,
.chat-input-container input::after {
  content: '|';
  position: absolute;
  right: 50px;
  color: #757575; /* Средне-серый для курсора */
  animation: blink 0.7s step-end infinite;
}
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0; }
}

/* --- Адаптив --- */
@media (max-width: 900px) {
  .hero-text h1 {
    font-size: 40px;
  }
  .hero-subtitle {
    font-size: 18px;
    max-width: 100%;
  }
  .chat-widget {
    height: 420px;
    position: sticky;
    bottom: 20px;
    margin-top: 20px;
    z-index: 10;
  }
  .hero-chat {
    padding: 40px 20px 80px;
  }
  .chat-header h2 {
    font-size: 18px;
  }
  .initial-input-container {
    width: 90%;
    max-width: 700px;
  }
  .initial-input-container input {
    font-size: 18px;
    padding: 16px;
  }
  .initial-input-container button {
    width: 40px;
    height: 40px;
  }
  .chat-input-container button {
    width: 28px;
    height: 28px;
    margin-left: 6px;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Инициализация GSAP и ScrollTrigger
  gsap.registerPlugin(ScrollTrigger);

  // Анимация чат-виджета (основной контейнер)
  gsap.fromTo(
    "#chatWidget",
    {
      opacity: 0,
      y: 80,
      scale: 0.9,
      rotate: 2
    },
    {
      opacity: 1,
      y: 0,
      scale: 1,
      rotate: 0,
      duration: 1.5,
      ease: "power3.out",
      scrollTrigger: {
        trigger: "#hero-chat",
        start: "top 40%",
        end: "top -10%",
        scrub: 1,
        toggleActions: "play none none reverse"
      }
    }
  );

  // Анимация заголовка
  gsap.fromTo(
    "#chatHeader",
    { opacity: 0, y: -20 },
    {
      opacity: 1,
      y: 0,
      duration: 1,
      delay: 0.2,
      ease: "power2.out",
      scrollTrigger: {
        trigger: "#hero-chat",
        start: "top 90%",
        end: "top -20%",
        scrub: 1
      }
    }
  );

  // Анимация начального поля ввода
  gsap.fromTo(
    "#initialInputContainer",
    { opacity: 0, scale: 0.8 },
    {
      opacity: 1,
      scale: 1,
      duration: 1,
      delay: 0.4,
      ease: "power2.out",
      scrollTrigger: {
        trigger: "#hero-chat",
        start: "top 90%",
        end: "top -20%",
        scrub: 1
      }
    }
  );

  // Показ подсказки через 3 секунды
  const chatHint = document.querySelector('.chat-hint');
  setTimeout(() => {
    chatHint.classList.remove('hidden');
    gsap.fromTo(
      chatHint,
      { opacity: 1 },
      { opacity: 0.8, duration: 1, repeat: -1, yoyo: true }
    );
  }, 2000);

  // Элементы чата
  const initialChatInput = document.getElementById('initialChatInput');
  const chatInput = document.getElementById('chatInput');
  const initialSendButton = document.getElementById('initialSendButton');
  const sendButton = document.getElementById('sendButton');
  const chatMessages = document.getElementById('chatMessages');
  const container = document.querySelector('.chat-messages-container');
  const initialInputContainer = document.getElementById('initialInputContainer');
  const chatInputContainer = document.getElementById('chatInputContainer');

  // Логика смены placeholder с эффектом печати
  const placeholders = [
    "Задайте свой вопрос...",
    "Опишите свою задачу...",
    "Расскажите, чем помочь...",
    "Введите ваш запрос..."
  ];
  let currentPlaceholderIndex = 0;
  let isTyping = false;

  function typePlaceholder(text, inputElement, callback) {
    if (isTyping) return;
    isTyping = true;
    let index = 0;
    inputElement.placeholder = '';

    function typeChar() {
      if (index < text.length) {
        inputElement.placeholder += text[index];
        index++;
        setTimeout(typeChar, 100);
      } else {
        isTyping = false;
        setTimeout(callback, 2000);
      }
    }
    typeChar();
  }

  function updatePlaceholder() {
    const currentText = placeholders[currentPlaceholderIndex];
    const activeInput = !initialInputContainer.classList.contains('hidden') ? initialChatInput : chatInput;
    typePlaceholder(currentText, activeInput, () => {
      currentPlaceholderIndex = (currentPlaceholderIndex + 1) % placeholders.length;
      updatePlaceholder();
    });
  }

  // Начинаем анимацию placeholder
  updatePlaceholder();

  // Логика чата
  function scrollToBottom() {
    container.scrollTop = container.scrollHeight;
  }

  function sendMessage(inputElement, isInitial = false) {
    const text = inputElement.value.trim();
    if (!text) return;
    inputElement.value = '';

    // Добавляем сообщение пользователя
    const userMessage = document.createElement('div');
    userMessage.className = 'message user-message1';
    userMessage.textContent = text;
    chatMessages.appendChild(userMessage);
    scrollToBottom();

    // Если это первое сообщение, скрываем начальное поле и показываем стандартное
    if (isInitial) {
      gsap.to(initialInputContainer, {
        opacity: 0,
        scale: 0.8,
        duration: 0.5,
        ease: "power2.in",
        onComplete: () => {
          initialInputContainer.classList.add('hidden');
          chatInputContainer.classList.remove('hidden');
          gsap.fromTo(
            chatInputContainer,
            { opacity: 0, y: 20 },
            { opacity: 1, y: 0, duration: 0.5, ease: "power2.out" }
          );
          chatInput.placeholder = placeholders[currentPlaceholderIndex];
        }
      });
    }

    // Ответ бота
    setTimeout(() => {
      const botMessage = document.createElement('div');
      botMessage.className = 'message bot-message1';
      botMessage.textContent = 'Это тестовый ответ. Чем могу помочь?';
      chatMessages.appendChild(botMessage);
      scrollToBottom();
    }, 800);
  }

  // Обработчики для начального поля
  if (initialSendButton && initialChatInput) {
    initialSendButton.addEventListener('click', () => sendMessage(initialChatInput, true));
    initialChatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage(initialChatInput, true);
    });
  }

  // Обработчики для стандартного поля
  if (sendButton && chatInput) {
    sendButton.addEventListener('click', () => sendMessage(chatInput));
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage(chatInput);
    });
  }
});
</script>