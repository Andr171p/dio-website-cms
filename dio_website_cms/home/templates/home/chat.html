{% load wagtailcore_tags wagtailimages_tags static %}

<!-- Hero с чатом -->
<section id="hero-chat" class="hero-chat relative">
  <div class=" container">
    <!-- Заголовок и подзаголовок -->
    <div class="hero-text text-center">
      <h1 class="heading_h1">AI-Алёша</h1>
      <p class="hero-subtitle heading_h4">Ваш AI-помощник Алёша всегда на связи. Задайте вопрос и получите быстрый ответ прямо здесь.</p>
    </div>
    <!-- Чат -->
    <div class="chat-widget" id="chatWidget">
      <div class="chat-header" id="chatHeader">
        <h2 class="heading_h2">Алёша</h2>
        <span class="chat-hint animate-pulse hidden">Спросите Алёшу</span>
      </div>
      <div class="chat-messages-container" id="chatMessagesContainer">
        <div class="chat-messages" id="chatMessages">
          <!-- Начальное сообщение бота (опционально, можно убрать) -->
          <!-- <div class="message bot-message1">Здравствуйте! Чем могу помочь?</div> -->
        </div>
        <!-- Большое поле ввода в центре -->
        <div class="initial-input-container" id="initialInputContainer">
          <input type="text" id="initialChatInput" placeholder="Задайте свой вопрос..." aria-label="Введите первый вопрос">
          <button id="initialSendButton" aria-label="Отправить сообщение">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#fff"/>
            </svg>
          </button>
        </div>
      </div>
      <!-- Стандартное поле ввода (скрыто по умолчанию) -->
      <div class="chat-input-container hidden" id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="С чем вам помочь?" aria-label="Введите сообщение">
        <button id="sendButton" aria-label="Отправить сообщение">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#fff"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Инициализация GSAP и ScrollTrigger
  gsap.registerPlugin(ScrollTrigger);

  // Анимация чат-виджета (основной контейнер)
  gsap.fromTo(
    "#chatWidget",
    { opacity: 0, y: 80, scale: 0.9, rotate: 2 },
    { opacity: 1, y: 0, scale: 1, rotate: 0, duration: 1.5, ease: "power3.out", scrollTrigger: { trigger: "#hero-chat", start: "top 40%", end: "top -10%", scrub: 1, toggleActions: "play none none reverse" } }
  );

  // Анимация заголовка
  gsap.fromTo(
    "#chatHeader",
    { opacity: 0, y: -20 },
    { opacity: 1, y: 0, duration: 1, delay: 0.2, ease: "power2.out", scrollTrigger: { trigger: "#hero-chat", start: "top 90%", end: "top -20%", scrub: 1 } }
  );

  // Элементы чата
  const initialChatInput = document.getElementById('initialChatInput');
  const chatInput = document.getElementById('chatInput');
  const initialSendButton = document.getElementById('initialSendButton');
  const sendButton = document.getElementById('sendButton');
  const chatMessages = document.getElementById('chatMessages');
  const container = document.querySelector('.chat-messages-container');
  const initialInputContainer = document.getElementById('initialInputContainer');
  const chatInputContainer = document.getElementById('chatInputContainer');
  const placeholders = ["Задайте свой вопрос...", "Опишите свою задачу...", "Расскажите, чем помочь...", "Введите ваш запрос..."];

  // Генерация или получение уникального chatId
  let chatId = localStorage.getItem('chatId');
  if (!chatId) {
    chatId = 'chat_' + Math.random().toString(36).substr(2, 9); // Уникальный ID
    localStorage.setItem('chatId', chatId);
  }

  // Загрузка истории из localStorage
  let chatHistory = JSON.parse(localStorage.getItem(`chatHistory_${chatId}`)) || [];
  chatHistory.forEach(message => addMessage(message.role, message.text));

  // Проверка наличия истории и скрытие начального окна
  let currentPlaceholderIndex = 0; // Перемещено выше
  if (chatHistory.length > 0) {
    initialInputContainer.classList.add('hidden');
    chatInputContainer.classList.remove('hidden');
    gsap.fromTo(chatInputContainer, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5, ease: "power2.out" });
    chatInput.placeholder = placeholders[currentPlaceholderIndex];
  }

  // Показ подсказки через 3 секунды
  const chatHint = document.querySelector('.chat-hint');
  setTimeout(() => {
    chatHint.classList.remove('hidden');
    gsap.fromTo(chatHint, { opacity: 1 }, { opacity: 0.8, duration: 1, repeat: -1, yoyo: true });
  }, 2000);

  // Логика смены placeholder с эффектом печати
  let isTyping = false;

  function typePlaceholder(text, inputElement, callback) {
    if (isTyping) return;
    isTyping = true;
    let index = 0;
    inputElement.placeholder = '';
    function typeChar() {
      if (index < text.length) {
        inputElement.placeholder += text[index];
        index++;
        setTimeout(typeChar, 100);
      } else {
        isTyping = false;
        setTimeout(callback, 2000);
      }
    }
    typeChar();
  }

  function updatePlaceholder() {
    const currentText = placeholders[currentPlaceholderIndex];
    const activeInput = !initialInputContainer.classList.contains('hidden') ? initialChatInput : chatInput;
    typePlaceholder(currentText, activeInput, () => {
      currentPlaceholderIndex = (currentPlaceholderIndex + 1) % placeholders.length;
      updatePlaceholder();
    });
  }
  updatePlaceholder();

  // Логика чата
  function scrollToBottom() {
  requestAnimationFrame(() => {
    const container = document.querySelector('.chat-messages-container');
    container.scrollTop = container.scrollHeight;
  });
}


  function addMessage(role, text) {
  const messageDiv = document.createElement('div');
  messageDiv.className = role === 'ai' ? 'message bot-message1' : 'message user-message1';
  if (role === 'ai') {
    messageDiv.innerHTML = marked.parse(text); // Сразу рендерим Markdown
  } else {
    messageDiv.textContent = text;
  }
  chatMessages.appendChild(messageDiv);
  requestAnimationFrame(scrollToBottom); // Прокрутка после добавления
}

  function typeEffect(element, text, delay = 15) {
  let index = 0;
  element.innerHTML = ''; // Очищаем содержимое
  function typeChar() {
    if (index < text.length) {
      index++;
      const partialText = text.slice(0, index); // Берем подстроку
      if (element.classList.contains('bot-message1')) {
        // Рендерим Markdown для текущей подстроки
        element.innerHTML = marked.parse(partialText);
      } else {
        element.textContent = partialText; // Для пользовательских сообщений просто текст
      }
      // Прокрутка после каждого шага
      requestAnimationFrame(scrollToBottom);
      setTimeout(typeChar, delay);
    }
  }
  typeChar();
}

  function startTypingAnimation(element) {
    let dotCount = 0;
    element.textContent = 'Печатает';
    const typingInterval = setInterval(() => {
      dotCount = (dotCount + 1) % 4;
      element.textContent = 'Печатает' + '.'.repeat(dotCount);
    }, 500);
    return typingInterval;
  }

 async function sendMessageToAPI(chatId, message) {
  const typingMessage = document.createElement('div');
  typingMessage.className = 'message bot-message1 typing-message heading_h1';
  chatMessages.appendChild(typingMessage);
  requestAnimationFrame(scrollToBottom); // Прокрутка для индикатора "Печатает"

  const typingInterval = startTypingAnimation(typingMessage);

  try {
    const response = await fetch('http://localhost:8001/api/v1/rag', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ chat_id: chatId, role: 'user', text: message })
    });
    if (!response.ok) throw new Error('Ошибка сети');
    const data = await response.json();
    clearInterval(typingInterval);
    chatMessages.removeChild(typingMessage);
    const botMessage = document.createElement('div');
    botMessage.className = 'message bot-message1 heading_h1';
    chatMessages.appendChild(botMessage);
    typeEffect(botMessage, data.text); // typeEffect уже включает scrollToBottom
    // Сохранение истории
    chatHistory.push({ role: 'user', text: message });
    chatHistory.push({ role: 'ai', text: data.text });
    localStorage.setItem(`chatHistory_${chatId}`, JSON.stringify(chatHistory));
  } catch (error) {
    clearInterval(typingInterval);
    chatMessages.removeChild(typingMessage);
    addMessage('ai', 'Ошибка при получении ответа.');
    chatHistory.push({ role: 'ai', text: 'Ошибка при получения ответа.' });
    localStorage.setItem(`chatHistory_${chatId}`, JSON.stringify(chatHistory));
    requestAnimationFrame(scrollToBottom); // Прокрутка при ошибке
  }
}

  function sendMessage(inputElement, isInitial = false) {
    const text = inputElement.value.trim();
    if (!text) return;
    inputElement.value = '';

    addMessage('user', text);

    if (isInitial) {
      gsap.to(initialInputContainer, {
        opacity: 0, scale: 0.8, duration: 0.5, ease: "power2.in",
        onComplete: () => {
          initialInputContainer.classList.add('hidden');
          chatInputContainer.classList.remove('hidden');
          gsap.fromTo(chatInputContainer, { opacity: 0, y: 20 }, { opacity: 1, y: 0, duration: 0.5, ease: "power2.out" });
          chatInput.placeholder = placeholders[currentPlaceholderIndex];
        }
      });
    }

    sendMessageToAPI(chatId, text);
  }

  // Обработчики для начального поля
  if (initialSendButton && initialChatInput) {
    initialSendButton.addEventListener('click', () => sendMessage(initialChatInput, true));
    initialChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(initialChatInput, true); });
  }

  // Обработчики для стандартного поля
  if (sendButton && chatInput) {
    sendButton.addEventListener('click', () => sendMessage(chatInput));
    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(chatInput); });
  }
});
</script>