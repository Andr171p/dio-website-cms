{% load wagtailcore_tags wagtailimages_tags static %}

<!-- Hero с чатом — СТЕКЛЯННЫЙ КАК В MAC -->
<section id="hero-chat" class="hero-chat">
  <div class="container container_chat">
    <!-- Фоновые фигуры для стеклянного эффекта -->
    <div class="bg-shape shape-1"></div>
    <div class="bg-shape shape-2"></div>
    <div class="bg-shape shape-3"></div>

    <!-- Заголовок -->
    <div class="hero-text text-center">
      <h1 class="heading_h1">AI-Алёша</h1>
      <p class="hero-subtitle heading_h4">Ваш AI-помощник Алёша всегда на связи. Задайте вопрос и получите быстрый ответ прямо здесь.</p>
    </div>

    <!-- Чат -->
    <div class="chat-widget" id="chatWidget">
      <div class="chat-header" id="chatHeader">
        <h2 class="heading_h2">Алёша</h2>
        <span class="chat-hint animate-pulse hidden">Спросите Алёшу</span>
        <button id="clearChatButton" class="heading_h5 clear-chat-button">Очистить чат</button>
      </div>

      <div class="chat-messages-container" id="chatMessagesContainer">
        <div class="chat-messages" id="chatMessages"></div>

        <!-- Начальное поле ввода -->
        <div class="initial-input-container" id="initialInputContainer">
          <input type="text" id="initialChatInput" placeholder="Задайте свой вопрос..." aria-label="Введите первый вопрос">
          <button id="initialSendButton" aria-label="Отправить">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#fff"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Нижнее поле ввода -->
      <div class="chat-input-container hidden" id="chatInputContainer">
        <input type="text" id="chatInput" placeholder="С чем вам помочь?" aria-label="Введите сообщение">
        <button id="sendButton" aria-label="Отправить">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" fill="#fff"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</section>

<style>
  /* === ФОН С ФИГУРАМИ (чтобы стекло было видно) === */
  .hero-chat {
    background: linear-gradient(135deg, #141414 0%, #141414 50%, #141414 100%);
    padding: 60px 20px 100px;
    min-height: 100vh;
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .bg-shape {
    position: absolute;
    border-radius: 50%;
    filter: blur(0px);
    opacity: 0.4;
    z-index: 0;
    pointer-events: none;
  }
  .shape-1 {
    width: 600px;
    height: 600px;
    background: linear-gradient(45deg, #810000, #990612);
    top: 700px;
    left: -200px;
    animation: float 20s infinite ease-in-out;
  }
  .shape-2 {
    width: 500px;
    height: 500px;
    background: linear-gradient(45deg, #333333, #775252);
    bottom: -350px;
    right: -150px;
    animation: float 25s infinite ease-in-out reverse;
  }
  .shape-3 {
    width: 400px;
    height: 400px;
    background: linear-gradient(45deg, #252525, #8d6d6d);
    top: 40%;
    left: 50%;
    transform: translateX(-50%);
    animation: float 18s infinite ease-in-out;
  }

  @keyframes float {
    0%, 100% { transform: translateY(0) rotate(0deg); }
    50% { transform: translateY(-40px) rotate(5deg); }
  }

  /* === КОНТЕЙНЕР === */
  .container_chat {
    max-width: 1700px;
    width: 100%;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  /* === ТЕКСТ === */
  .hero-text {
    margin-bottom: 48px;
    z-index: 1;
  }
  

  /* === СТЕКЛЯННЫЙ ЧАТ (macOS-style) === */
  .chat-widget {
    background: rgba(255, 255, 255, 0.22);
    border-radius: 28px;
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 
      0 12px 40px rgba(0, 0, 0, 0.15),
      0 0 0 1px rgba(255, 255, 255, 0.3);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    max-width: 1700px;
    width: 100%;
    height: 820px;
    margin: 0 auto;
    z-index: 1;
  }

  .chat-header {
    background: rgba(255, 255, 255, 0.28);
    padding: 16px 24px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    backdrop-filter: blur(12px);
    display: flex;
    align-items: center;
    gap: 12px;
  }
 
  .chat-hint {
    font-size: 14px;
    color: #ffffff;
  }

  .clear-chat-button {
    background: #920707;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    margin-left: auto;
  }
  .clear-chat-button:hover {
    background: #cc0a0a;
    transform: translateY(-1px);
  }

  .chat-messages-container {
    flex: 1;
    padding: 24px;
    padding-right: 16px;
    overflow-y: auto;
    background: transparent;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  /* Скролл */
  .chat-messages-container::-webkit-scrollbar {
    width: 6px;
  }
  .chat-messages-container::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 3px;
  }
  .chat-messages-container::-webkit-scrollbar-thumb {
    background: rgba(203, 213, 225, 0.6);
    border-radius: 3px;
  }
  .chat-messages-container::-webkit-scrollbar-thumb:hover {
    background: rgba(148, 163, 184, 0.8);
  }

  .message {
    padding: 14px 20px;
    border-radius: 20px;
    font-size: 20px;
    line-height: 1.45;
    max-width: 78%;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    animation: fadeInUp 0.35s ease-out;
    word-wrap: break-words;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .bot-message1 {
    align-self: flex-start;
    background: rgba(255, 255, 255, 0.5);
    color: #ffffff;
    border: 1px solid rgba(226, 232, 240, 0.6);
    backdrop-filter: blur(10px);
  }

  .user-message1 {
    align-self: flex-end;
    background: rgba(204, 10, 10, 0.9);
    color: #fff;
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.25);
  }

  /* === ПОЛЯ ВВОДА === */
.initial-input-container,
.chat-input-container {
    position: relative;
    background: transparent;
    border-radius: 28px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
}

.initial-input-container::before,
.chat-input-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    -webkit-backdrop-filter: blur(16px);
    border-radius: 28px;
    z-index: -1;
}

  .initial-input-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 94%;
    max-width: 1000px;
    z-index: 10;
  }

  .chat-input-container {
    margin: 0 20px 16px;
    border-radius: 24px;
  }

  .initial-input-container input,
  .chat-input-container input {
    flex: 1;
    border: none;
    outline: none;
    background: transparent;
    font-size: 20px;
    color: #ffffff;
    border-bottom: 2px solid rgba(203, 213, 225, 0.7);
    padding: 8px 0;
    transition: border-color 0.3s ease;
    font-weight: 500;
  }

  .initial-input-container input {
    font-size: 28px;
  }

  .initial-input-container input::placeholder,
  .chat-input-container input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }

  .initial-input-container input:focus,
  .chat-input-container input:focus,
  .initial-input-container input:hover,
  .chat-input-container input:hover {
    border-color: #cc0a0a;
  }

  .initial-input-container button,
  .chat-input-container button {
    background: #cc0a0a;
    color: white;
    border: none;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(204, 10, 10, 0.35);
  }

  .chat-input-container button {
    width: 44px;
    height: 44px;
  }

  .initial-input-container button:hover,
  .chat-input-container button:hover {
    background: #a00808;
    transform: translateY(-2px) scale(1.06);
    box-shadow: 0 8px 24px rgba(204, 10, 10, 0.45);
  }

  .hidden { display: none !important; }

  /* === АДАПТИВ === */
  @media (max-width: 767px) {
    .shape-1 {
    width: 400px;
    height: 400px;
    background: linear-gradient(45deg, #810000, #990612);
    top: -200px;
    left: -200px;
    animation: float 20s infinite ease-in-out;
  }
  .shape-2 {
    width: 400px;
    height: 400px;
    background: linear-gradient(45deg, #333333, #775252);
    bottom: -150px;
    right: -150px;
    animation: float 25s infinite ease-in-out reverse;
  }
  .shape-3 {
    width: 400px;
    height: 400px;
    background: linear-gradient(45deg, #252525, #8d6d6d);
    top: 40%;
    left: 50%;
    transform: translateX(-50%);
    animation: float 18s infinite ease-in-out;
  }

    .hero-chat { padding: 20px 0; }
    .hero-text { padding: 0 16px; margin-bottom: 24px; }
    
    .chat-widget {
      height: calc(100vh - 180px);
      margin: 0;
      box-shadow: none;
    }
    .initial-input-container {
      width: 90%;
      max-width: 600px;
      padding: 16px;
    }
    .initial-input-container input { font-size: 22px; }
    .initial-input-container button { width: 48px; height: 48px; }
    .message { font-size: 18px; padding: 12px 16px; max-width: 85%; }
    .chat-messages-container { padding: 16px; }
    .bg-shape { filter: blur(60px); }
  }

  @media (max-width: 480px) {
    .heading_h1 { font-size: 28px; }
    .heading_h4 { font-size: 16px; }
    .chat-header { padding: 10px 12px; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
  // Страховка: сделать чат видимым и центрированным
  const chatWidget = document.getElementById('chatWidget');
  if (chatWidget) {
    chatWidget.style.opacity = '1';
    chatWidget.style.visibility = 'visible';
  }

  // Проверка загрузки GSAP
  if (typeof gsap === 'undefined' || typeof ScrollTrigger === 'undefined') {
    console.error('GSAP или ScrollTrigger не загружены');
    return;
  }

  // Инициализация GSAP и ScrollTrigger
  gsap.registerPlugin(ScrollTrigger);

  // Анимация чат-виджета
  gsap.fromTo(
    "#chatWidget",
    { opacity: 0, y: 80, scale: 0.9 },
    { 
      opacity: 1, 
      y: 0, 
      scale: 1, 
      duration: 1.5, 
      ease: "power3.out", 
      scrollTrigger: { 
        trigger: "#hero-chat", 
        start: "top 90%", 
        end: "top 30%", 
        scrub: 1, 
        toggleActions: "play none none reverse",
      },
      onComplete: () => {
        chatWidget.style.transform = 'none';
      }
    }
  );

  // Анимация заголовка
  gsap.fromTo(
    "#chatHeader",
    { opacity: 0, y: -20 },
    { 
      opacity: 1, 
      y: 0, 
      duration: 1, 
      delay: 0.2, 
      ease: "power2.out", 
      scrollTrigger: { 
        trigger: "#hero-chat", 
        start: "top 90%", 
        end: "top 30%", 
        scrub: 1,
      },
      onComplete: () => {
        document.getElementById('chatHeader').style.transform = 'none';
      }
    }
  );

  // Элементы чата
  const initialChatInput = document.getElementById('initialChatInput');
  const chatInput = document.getElementById('chatInput');
  const initialSendButton = document.getElementById('initialSendButton');
  const sendButton = document.getElementById('sendButton');
  const chatMessages = document.getElementById('chatMessages');
  const container = document.querySelector('.chat-messages-container');
  const initialInputContainer = document.getElementById('initialInputContainer');
  const chatInputContainer = document.getElementById('chatInputContainer');
  const clearChatButton = document.getElementById('clearChatButton');
  const placeholders = ["Задайте свой вопрос...", "Опишите свою задачу...", "Расскажите, чем помочь...", "Введите ваш запрос..."];

  // Генерация или получение уникального chatId
  let chatId = localStorage.getItem('chatId');
  if (!chatId) {
    chatId = 'chat_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('chatId', chatId);
  }

  // Загрузка истории из localStorage
  let chatHistory = JSON.parse(localStorage.getItem(`chatHistory_${chatId}`)) || [];
  chatHistory.forEach(message => addMessage(message.role, message.text));

  // Проверка наличия истории и скрытие начального окна
  let currentPlaceholderIndex = 0;
  if (chatHistory.length > 0) {
    initialInputContainer.classList.add('hidden');
    chatInputContainer.classList.remove('hidden');
    gsap.fromTo(
      chatInputContainer, 
      { opacity: 0, y: 20 }, 
      { 
        opacity: 1, 
        y: 0, 
        duration: 0.5, 
        ease: "power2.out",
        onComplete: () => {
          document.getElementById('chatInputContainer').style.transform = 'none';
        }
      }
    );
    chatInput.placeholder = placeholders[currentPlaceholderIndex];
  }

  // Показ подсказки через 2 секунды
  const chatHint = document.querySelector('.chat-hint');
  setTimeout(() => {
    if (chatHint) {
      chatHint.classList.remove('hidden');
      gsap.fromTo(
        chatHint, 
        { opacity: 0.1 }, 
        { opacity: 0.1, duration: 0.1, repeat: -1, yoyo: true }
      );
    }
  }, 2);

  // Логика смены placeholder
  let isTyping = false;

  function typePlaceholder(text, inputElement, callback) {
    if (isTyping || !inputElement) return;
    isTyping = true;
    let index = 0;
    inputElement.placeholder = '';
    function typeChar() {
      if (index < text.length) {
        inputElement.placeholder += text[index];
        index++;
        setTimeout(typeChar, 100);
      } else {
        isTyping = false;
        setTimeout(callback, 2000);
      }
    }
    typeChar();
  }

  function updatePlaceholder() {
    const currentText = placeholders[currentPlaceholderIndex];
    const activeInput = !initialInputContainer.classList.contains('hidden') ? initialChatInput : chatInput;
    if (activeInput) {
      typePlaceholder(currentText, activeInput, () => {
        currentPlaceholderIndex = (currentPlaceholderIndex + 1) % placeholders.length;
        updatePlaceholder();
      });
    }
  }
  updatePlaceholder();

  // Логика чата
  function scrollToBottom() {
    requestAnimationFrame(() => {
      if (container) {
        container.scrollTop = container.scrollHeight;
      }
    });
  }

  function addMessage(role, text) {
    const messageDiv = document.createElement('div');
    messageDiv.className = role === 'ai' ? 'message bot-message1' : 'message user-message1';
    if (role === 'ai') {
      messageDiv.innerHTML = marked.parse(text);
    } else {
      messageDiv.textContent = text;
    }
    chatMessages.appendChild(messageDiv);
    requestAnimationFrame(scrollToBottom);
  }

  function typeEffect(element, text, delay = 15) {
    let index = 0;
    element.innerHTML = '';
    function typeChar() {
      if (index < text.length) {
        index++;
        const partialText = text.slice(0, index);
        if (element.classList.contains('bot-message1')) {
          element.innerHTML = marked.parse(partialText);
        } else {
          element.textContent = partialText;
        }
        requestAnimationFrame(scrollToBottom);
        setTimeout(typeChar, delay);
      }
    }
    typeChar();
  }

  function startTypingAnimation(element) {
    let dotCount = 0;
    element.textContent = 'Печатает';
    const typingInterval = setInterval(() => {
      dotCount = (dotCount + 1) % 4;
      element.textContent = 'Печатает' + '.'.repeat(dotCount);
    }, 500);
    return typingInterval;
  }

  async function sendMessageToAPI(chatId, message) {
    const typingMessage = document.createElement('div');
    typingMessage.className = 'message bot-message1 typing-message';
    chatMessages.appendChild(typingMessage);
    requestAnimationFrame(scrollToBottom);

    const typingInterval = startTypingAnimation(typingMessage);

    try {
      const response = await fetch('http://localhost:8001/api/v1/rag', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ chat_id: chatId, role: 'user', text: message })
      });
      if (!response.ok) throw new Error('Ошибка сети');
      const data = await response.json();
      clearInterval(typingInterval);
      chatMessages.removeChild(typingMessage);
      const botMessage = document.createElement('div');
      botMessage.className = 'message bot-message1';
      chatMessages.appendChild(botMessage);
      typeEffect(botMessage, data.text);
      chatHistory.push({ role: 'user', text: message });
      chatHistory.push({ role: 'ai', text: data.text });
      localStorage.setItem(`chatHistory_${chatId}`, JSON.stringify(chatHistory));
    } catch (error) {
      clearInterval(typingInterval);
      chatMessages.removeChild(typingMessage);
      addMessage('ai', 'Ошибка при получении ответа.');
      chatHistory.push({ role: 'ai', text: 'Ошибка при получении ответа.' });
      localStorage.setItem(`chatHistory_${chatId}`, JSON.stringify(chatHistory));
      requestAnimationFrame(scrollToBottom);
    }
  }

  function sendMessage(inputElement, isInitial = false) {
    const text = inputElement.value.trim();
    if (!text) return;
    inputElement.value = '';

    addMessage('user', text);

    if (isInitial) {
      gsap.to(
        initialInputContainer, 
        { 
          opacity: 0, 
          scale: 0.8, 
          duration: 0.5, 
          ease: "power2.in",
          onComplete: () => {
            initialInputContainer.classList.add('hidden');
            chatInputContainer.classList.remove('hidden');
            gsap.fromTo(
              chatInputContainer, 
              { opacity: 0, y: 20 }, 
              { 
                opacity: 1, 
                y: 0, 
                duration: 0.5, 
                ease: "power2.out",
                onComplete: () => {
                  document.getElementById('chatInputContainer').style.transform = 'none';
                }
              }
            );
            chatInput.placeholder = placeholders[currentPlaceholderIndex];
          }
        }
      );
    }

    sendMessageToAPI(chatId, text);
  }

  // Обработчики для начального поля
  if (initialSendButton && initialChatInput) {
    initialSendButton.addEventListener('click', () => sendMessage(initialChatInput, true));
    initialChatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(initialChatInput, true); });
  }

  // Обработчики для стандартного поля
  if (sendButton && chatInput) {
    sendButton.addEventListener('click', () => sendMessage(chatInput));
    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(chatInput); });
  }

  // Обработчик для очистки чата
  if (clearChatButton) {
    clearChatButton.addEventListener('click', clearChat);
  }

  // Адаптация высоты для мобильных устройств
  function adjustChatHeight() {
    if (window.innerWidth <= 767) {
      const chatWidget = document.getElementById('chatWidget');
      const heroText = document.querySelector('.hero-text');
      const availableHeight = window.innerHeight - (heroText ? heroText.offsetHeight : 0) - 40;
      chatWidget.style.height = `${availableHeight}px`;
    }
  }

  // Вызов при загрузке и изменении размера окна
  adjustChatHeight();
  window.addEventListener('resize', adjustChatHeight);

  // Функция очистки чата
  function clearChat() {
    chatMessages.innerHTML = ''; // Очищаем сообщения на экране
    chatHistory = []; // Очищаем историю
    localStorage.removeItem(`chatHistory_${chatId}`); // Удаляем историю из localStorage
    initialInputContainer.classList.remove('hidden'); // Показываем начальное поле
    chatInputContainer.classList.add('hidden'); // Скрываем стандартное поле
    chatInput.value = ''; // Очищаем поле ввода
    gsap.fromTo(
      initialInputContainer,
      { opacity: 0, y: 20 },
      { opacity: 1, y: 0, duration: 0.5, ease: "power2.out" }
    );
  }
});
</script>