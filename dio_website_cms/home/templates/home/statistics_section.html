{% load wagtailcore_tags wagtailimages_tags static %}

<section class="section is-secondary pt-1 pb-10  ">
    <div class="container">
        <div class="margin-top_large">
            <!-- Header -->
            <div class="divider margin-bottom_medium text-center">
                <h2 class="heading_h4">Наши достижения в цифрах</h2>
                <p class="paragraph_large text-color_secondary ">
                    Результаты многолетней работы в сфере автоматизации бизнеса и внедрения информационных систем.
                </p>
            </div>

            <!-- Stats Grid (Основные достижения) -->
            <ul role="list" class="grid_4-col tablet-2-col mobile-1-col gap-medium w-list-unstyled">
                {% for achievement in main_achievements %}
                <li class="stat-item text-center">
                    

                    <!-- Number -->
                    <div class="heading_h3 text-color_primary margin-bottom_xsmall counter-element" 
                         data-value="{{ achievement.value.value }}" data-suffix="{{ achievement.value.suffix }}">
                        0{{ achievement.value.suffix }}
                    </div>

                    <!-- Label -->
                    <h3 class="heading_h5 margin-bottom_xsmall">
                        {{ achievement.value.label }}
                    </h3>

                    <!-- Description -->
                    <!-- <p class="paragraph_small text-color_secondary">{{ achievement.value.description|richtext }}</p> -->

                    
                </li>
                {% endfor %}
            </ul>

            <!-- Additional Achievements -->
            {% if additional_achievements %}
            <div class="margin-top_xlarge padding-top_large border-top_light">
                <ul role="list" class="grid_3-col tablet-1-col gap-medium w-list-unstyled">
                    {% for achievement in additional_achievements %}
                    <li class="text-center">
                        <div class="heading_h3 text-color_primary margin-bottom_xsmall counter-element" 
                             data-value="{{ achievement.value.value }}">
                            {{ achievement.value.value }}
                        </div>
                        <h4 class="heading_h6 margin-bottom_xsmall">
                            {{ achievement.value.title }}
                        </h4>
                        <p class="paragraph_small text-color_secondary">{{ achievement.value.description|richtext }}</p>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<style>
.counter-element {
    transition: color 0.3s ease;
}

.counter-element.animated {
    color: var(--accent-color);
}


.animate-on-scroll {
    animation: countUp 0.8s ease-out forwards;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для анимации счетчиков
    function animateCounter(element, start, end, duration, suffix = '') {
        let startTime = null;
        
        function updateCounter(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / (duration * 1000), 1);
            const currentValue = Math.floor(progress * (end - start) + start);
            element.textContent = currentValue + suffix;
            
            if (progress < 1) {
                requestAnimationFrame(updateCounter);
            } else {
                element.classList.add('animated');
            }
        }
        
        requestAnimationFrame(updateCounter);
    }

    // Функция для проверки видимости элемента
    function isElementInViewport(el) {
        const rect = el.getBoundingClientRect();
        return (
            rect.top <= (window.innerHeight || document.documentElement.clientHeight) * 0.8 &&
            rect.bottom >= 0
        );
    }

    // Запуск анимации при скролле
    function handleScroll() {
        const counters = document.querySelectorAll('.counter-element');
        counters.forEach(counter => {
            if (isElementInViewport(counter) && !counter.classList.contains('animated')) {
                const value = parseInt(counter.getAttribute('data-value'));
                const suffix = counter.getAttribute('data-suffix') || '';
                counter.classList.add('animate-on-scroll');
                animateCounter(counter, 0, value, 2, suffix);
            }
        });
    }

    // Проверяем при загрузке и при скролле
    window.addEventListener('scroll', handleScroll);
    handleScroll(); // Проверить сразу при загрузке
});
</script>

{% load wagtailcore_tags wagtailimages_tags static %}

<section class="section is-secondary pt-1">
    <div class="container">
        <div class="margin-top_large">
            <!-- Header -->
            <div class="divider margin-bottom_medium text-center">
                <h2 class="heading_h4">Наши достижения в цифрах</h2>
                <p class="paragraph_large text-color_secondary">
                    Результаты многолетней работы в сфере автоматизации бизнеса и внедрения информационных систем.
                </p>
            </div>

            <!-- Main Content - Stats on left, testimonial on right -->
            <div class="w-layout-grid grid_2-col tablet-1-col gap-xlarge">
                <!-- Left Column - Statistics -->
                <div>
                    <!-- Main Achievements -->
                    <ul role="list" class="grid_2-col mobile-1-col gap-medium w-list-unstyled">
                        {% for achievement in main_achievements %}
                        <li class="stat-item">
                            <!-- Number -->
                            <div class="heading_h3 text-color_primary margin-bottom_xsmall counter-element" 
                                 data-value="{{ achievement.value.value }}" data-suffix="{{ achievement.value.suffix }}">
                                0{{ achievement.value.suffix }}
                            </div>

                            <!-- Label -->
                            <h3 class="heading_h5 margin-bottom_xsmall">
                                {{ achievement.value.label }}
                            </h3>

                            <!-- Description -->
                            <!-- <p class="paragraph_small text-color_secondary">{{ achievement.value.description|richtext }}</p> -->

                            <!-- Divider -->
                            <div class="divider margin-top_small" style="max-width: 60px;"></div>
                        </li>
                        {% endfor %}
                    </ul>

                    <!-- Additional Achievements -->
                    {% if additional_achievements %}
                    <div class="margin-top_xlarge padding-top_large border-top_light">
                        <ul role="list" class="grid_2-col mobile-1-col gap-medium w-list-unstyled">
                            {% for achievement in additional_achievements %}
                            <li>
                                <div class="heading_h3 text-color_primary margin-bottom_xsmall counter-element" 
                                     data-value="{{ achievement.value.value }}">
                                    {{ achievement.value.value }}
                                </div>
                                <h4 class="heading_h6 margin-bottom_xsmall">
                                    {{ achievement.value.title }}
                                </h4>
                                <p class="paragraph_small text-color_secondary">{{ achievement.value.description|richtext }}</p>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <!-- Right Column - Testimonial -->
                <div class="testimonial-card card on-secondary w-node-_40dbe3e1-b810-1a50-0d31-082886e8dbe5-372e0d7f">
                    <div class="card_body">
                        <p class="eyebrow">Отзывы клиентов</p>
                        <div class="flex_horizontal is-y-center gap-xsmall margin-bottom_small ">
                            <img width="64" height="64" alt="Екатерина Кузнецова" 
                                 src="https://cdn.prod.website-files.com/68d0517d75ef0d388acbf76f/68d05623880d199c461dd270_a77e9196-83f4-460d-8172-312b03b35eb3.avif" 
                                 loading="lazy" class="avatar">
                            <div>
                                <div class="paragraph_small margin-bottom_none">Иванов Иван</div>
                                <div class="paragraph_small text-color_secondary margin-bottom_xxsmall">Компания</div>
                            </div>
                        </div>
                        <p class="paragraph_xlarge random-letters-element" 
                           data-text="«Автоматизация отчетности позволила нам сэкономить время и избежать ошибок. Партнерство полностью оправдало наши ожидания.»">
                            «Автоматизация отчетности позволила нам сэкономить время и избежать ошибок. Партнерство полностью оправдало наши ожидания.»
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
.counter-element {
    transition: color 0.3s ease;
}

.counter-element.animated {
    color: var(--accent-color);
}

@keyframes countUp {
    from { 
        opacity: 0; 
        transform: translateY(20px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.random-letters-element {
    position: relative;
}

.random-letters-element .letter {
    display: inline-block;
    transition: all 0.3s ease;
}

.random-letters-element.animated .letter {
    color: inherit !important;
}

.testimonial-card {
    background: var(--background-secondary);
    border-radius: 12px;
    padding: 2rem;
    height: fit-content;
    position: sticky;
    top: 2rem;
}

.avatar {
    border-radius: 50%;
    object-fit: cover;
}

@media (max-width: 767px) {
    .testimonial-card {
        position: static;
        margin-top: 2rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для генерации случайной кириллической буквы
    function getRandomCyrillicChar() {
        const cyrillicChars = 'абвгдеёжзийклмнопрстуфхцчшщъыьэюяАБВГДЕЁЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ';
        return cyrillicChars[Math.floor(Math.random() * cyrillicChars.length)];
    }

    // Функция для анимации пазла с плавной заменой букв
    function puzzleLettersAnimation(element, finalText, duration = 1500) {
        const textLength = finalText.length;
        let currentText = finalText.split(''); // Сохраняем исходную структуру

        // Инициализация текста с случайными буквами, где есть кириллица
        for (let i = 0; i < textLength; i++) {
            if (finalText[i].match(/[а-яА-ЯёЁ]/)) {
                currentText[i] = getRandomCyrillicChar();
            }
        }
        element.textContent = currentText.join('');

        // Функция для плавной замены каждой буквы
        function animateLetter(index, startTime) {
            if (!startTime) startTime = performance.now();
            const progress = Math.min((performance.now() - startTime) / (duration / textLength), 1);
            const easedProgress = progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 2) / 2; // Плавная кривая

            if (progress < 1 && finalText[index].match(/[а-яА-ЯёЁ]/)) {
                const interpolatedChar = easedProgress >= 0.5 ? finalText[index] : getRandomCyrillicChar();
                currentText[index] = interpolatedChar;
                element.textContent = currentText.join('');
                requestAnimationFrame((time) => animateLetter(index, startTime));
            } else if (progress >= 1) {
                currentText[index] = finalText[index]; // Убеждаемся, что финальная буква правильная
            }
        }

        // Запускаем анимацию для каждой буквы с небольшой случайной задержкой
        let completedLetters = 0;
        for (let i = 0; i < textLength; i++) {
            if (finalText[i].match(/[а-яА-ЯёЁ]/)) {
                const delay = Math.random() * (duration / 2); // Случайная задержка для эффекта пазла
                setTimeout(() => {
                    animateLetter(i, null);
                    completedLetters++;
                    if (completedLetters === textLength) {
                        element.classList.add('animated');
                    }
                }, delay);
            } else {
                currentText[i] = finalText[i]; // Сохраняем знаки препинания сразу
            }
        }
    }

    // Функция для анимации счетчиков
    function animateCounter(element, start, end, duration, suffix = '') {
        let startTime = null;

        function updateCounter(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = Math.min((timestamp - startTime) / (duration * 1000), 1);
            const currentValue = Math.floor(progress * (end - start) + start);
            element.textContent = currentValue + suffix;

            if (progress < 1) {
                requestAnimationFrame(updateCounter);
            } else {
                element.classList.add('animated');
            }
        }

        requestAnimationFrame(updateCounter);
    }

    // Функция для проверки видимости элемента
    function isElementInViewport(el) {
        const rect = el.getBoundingClientRect();
        return (
            rect.top <= (window.innerHeight || document.documentElement.clientHeight) * 0.8 &&
            rect.bottom >= 0
        );
    }

    // Запуск анимации при скролле
    function handleScroll() {
        // Анимация счетчиков
        const counters = document.querySelectorAll('.counter-element');
        counters.forEach(counter => {
            if (isElementInViewport(counter) && !counter.classList.contains('animated')) {
                const value = parseInt(counter.getAttribute('data-value'));
                const suffix = counter.getAttribute('data-suffix') || '';
                counter.classList.add('animate-on-scroll');
                animateCounter(counter, 0, value, 1.5, suffix); // Ускоренная анимация счетчиков
            }
        });

        // Анимация отзыва (только один раз)
        const testimonialElement = document.querySelector('.random-letters-element');
        if (testimonialElement && isElementInViewport(testimonialElement) && !testimonialElement.classList.contains('animated')) {
            const finalText = testimonialElement.getAttribute('data-text');
            puzzleLettersAnimation(testimonialElement, finalText, 1500); // Ускоренная анимация
        }
    }

    
});
</script>