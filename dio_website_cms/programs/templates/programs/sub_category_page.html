{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
<section class="section pt-10">
    <div class="container mx-auto px-4 lg:px-8 max-w-7xl">
        <!-- Введение в подкатегорию -->
        {% if page.intro %}
            <div class="header is-align-center mb-8">
                <div class="prose max-w-4xl mx-auto text-center">
                    {{ page.intro|richtext }}
                </div>
            </div>
        {% endif %}

        <!-- Изображение подкатегории -->
        {% if page.image %}
            <div class="mb-12">
                {% image page.image fill-1200x400 class="w-full h-auto rounded-lg shadow-lg gs-reveal" %}
            </div>
        {% endif %}

        <!-- Поиск и фильтры -->
        <div class="mb-8">
            <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
                <!-- Поисковая строка -->
                <div class="w-full md:w-1/2 relative">
                    <input type="text" id="product-search" placeholder="Поиск продуктов..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 bg-white text-gray-900 shadow-sm" autocomplete="off">
                    <div id="loading-spinner" class="hidden absolute right-3 top-1/2 -translate-y-1/2">
                        <svg class="animate-spin h-5 w-5 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                </div>
                <!-- Фильтры по производителям -->
                <div class="flex flex-wrap gap-2">
                    <a href="{% pageurl page %}?manufacturer=all" class="px-3 py-1.5 rounded-full font-medium text-sm transition-colors duration-200 {% if not request.GET.manufacturer or request.GET.manufacturer == 'all' %}bg-red-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-red-600 hover:text-white{% endif %}">
                        Все
                    </a>
                    {% for m in manufacturers %}
                        {% if m.manufacturer %}
                            <a href="{% pageurl page %}?manufacturer={{ m.manufacturer|urlencode }}" class="px-3 py-1.5 rounded-full font-medium text-sm transition-colors duration-200 {% if request.GET.manufacturer == m.manufacturer %}bg-red-600 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-red-600 hover:text-white{% endif %}">
                                {{ m.manufacturer }}
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Сетка продуктов -->
        <div class="w-layout-grid grid_3-col gap-6 mt-12" id="product-grid">
            {% for product in products %}
                <a href="{% pageurl product %}" class="card relative overflow-hidden rounded-xl shadow-lg group bg-white transition-transform duration-300 hover:-translate-y-1 hover:shadow-xl">
                    {% if product.specific.image %}
                        {% image product.specific.image fill-600x400 class="w-full h-48 object-cover rounded-t-xl" %}
                    {% else %}
                        <div class="w-full h-48 bg-gray-200 rounded-t-xl"></div>
                    {% endif %}
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-2">
                            {% if product.specific.manufacturer %}
                                <span class="px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs font-medium">
                                    {{ product.specific.manufacturer }}
                                </span>
                            {% endif %}
                        </div>
                        <h3 class="heading_h4 text-gray-900 font-semibold mb-2">{{ product.title }}</h3>
                        {% if product.specific.description %}
                            <p class="text-gray-600 text-sm line-clamp-2">
                                {{ product.specific.description|striptags|truncatewords:14 }}
                            </p>
                        {% endif %}
                        {% if product.specific.price %}
                            <p class="text-gray-900 font-bold mt-2">{{ product.specific.price }} {{ product.specific.currency }}</p>
                        {% endif %}
                        <div class="mt-4">
                            <span class="text-red-600 text-sm font-medium group-hover:underline">
                                Подробнее
                                <svg class="w-4 h-4 ml-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                            </span>
                        </div>
                    </div>
                </a>
            {% empty %}
                <div class="col-span-3 text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 text-red-600 rounded-full mb-4">
                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Продуктов пока нет</h3>
                    <p class="text-gray-500 max-w-md mx-auto">Скоро здесь появятся продукты в этой подкатегории.</p>
                </div>
            {% endfor %}
        </div>

        <!-- Пагинация -->
        {% if products.has_other_pages %}
            <div class="text-center mt-12">
                <ul class="inline-flex gap-2">
                    {% if products.has_previous %}
                        <li>
                            <a href="?page={{ products.previous_page_number }}{% if request.GET.manufacturer %}&manufacturer={{ request.GET.manufacturer }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-red-600 hover:text-white">
                                Предыдущая
                            </a>
                        </li>
                    {% endif %}
                    {% for num in products.paginator.page_range %}
                        <li>
                            <a href="?page={{ num }}{% if request.GET.manufacturer %}&manufacturer={{ request.GET.manufacturer }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="px-4 py-2 rounded-full {% if products.number == num %}bg-red-600 text-white{% else %}bg-gray-200 text-gray-700{% endif %} hover:bg-red-600 hover:text-white">
                                {{ num }}
                            </a>
                        </li>
                    {% endfor %}
                    {% if products.has_next %}
                        <li>
                            <a href="?page={{ products.next_page_number }}{% if request.GET.manufacturer %}&manufacturer={{ request.GET.manufacturer }}{% endif %}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="px-4 py-2 rounded-full bg-gray-200 text-gray-700 hover:bg-red-600 hover:text-white">
                                Следующая
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        {% endif %}
    </div>
</section>

<link href="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        gsap.registerPlugin(ScrollTrigger);
        gsap.utils.toArray('.gs-reveal').forEach(element => {
            gsap.fromTo(element,
                { opacity: 0, y: 20 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 0.8,
                    ease: "power2.out",
                    scrollTrigger: {
                        trigger: element,
                        start: "top 90%",
                        end: "bottom 20%",
                        toggleActions: "play none none reverse"
                    }
                }
            );
        });

        // AJAX-поиск
        const searchInput = document.getElementById('product-search');
        const productGrid = document.getElementById('product-grid');
        const spinner = document.getElementById('loading-spinner');
        
        let debounceTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimeout);
            spinner.classList.remove('hidden');

            debounceTimeout = setTimeout(() => {
                const query = this.value.trim();
                const manufacturer = new URLSearchParams(window.location.search).get('manufacturer') || 'all';
                fetch(`/programs/search/{{ page.pk }}/?q=${encodeURIComponent(query)}&manufacturer=${encodeURIComponent(manufacturer)}`)
                    .then(response => response.json())
                    .then(data => {
                        productGrid.innerHTML = '';
                        if (data.products.length === 0) {
                            productGrid.innerHTML = `
                                <div class="col-span-3 text-center py-12">
                                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 text-red-600 rounded-full mb-4">
                                        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <h3 class="text-xl font-semibold text-gray-600 mb-2">Продуктов не найдено</h3>
                                    <p class="text-gray-500 max-w-md mx-auto">Попробуйте изменить запрос.</p>
                                </div>
                            `;
                        } else {
                            data.products.forEach(product => {
                                const card = document.createElement('a');
                                card.href = product.url;
                                card.className = 'card relative overflow-hidden rounded-xl shadow-lg group bg-white transition-transform duration-300 hover:-translate-y-1 hover:shadow-xl';
                                card.innerHTML = `
                                    <div class="w-full h-48 ${product.image ? '' : 'bg-gray-200'} rounded-t-xl">
                                        ${product.image ? `<img src="${product.image}" class="w-full h-full object-cover rounded-t-xl" alt="${product.title}">` : ''}
                                    </div>
                                    <div class="p-6">
                                        <div class="flex items-center justify-between mb-2">
                                            ${product.manufacturer ? `<span class="px-2 py-1 rounded-full bg-red-100 text-red-800 text-xs font-medium">${product.manufacturer}</span>` : ''}
                                        </div>
                                        <h3 class="heading_h4 text-gray-900 font-semibold mb-2">${product.title}</h3>
                                        <p class="text-gray-600 text-sm line-clamp-2">${product.description}</p>
                                        ${product.price ? `<p class="text-gray-900 font-bold mt-2">${product.price} ${product.currency}</p>` : ''}
                                        <div class="mt-4">
                                            <span class="text-red-600 text-sm font-medium group-hover:underline">
                                                Подробнее
                                                <svg class="w-4 h-4 ml-1 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                                </svg>
                                            </span>
                                        </div>
                                    </div>
                                `;
                                productGrid.appendChild(card);
                            });
                        }
                        spinner.classList.add('hidden');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        spinner.classList.add('hidden');
                    });
            }, 300); // Дебаунсинг 300 мс
        });
    });
</script>

<style>
    .grid_3-col {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
    }
    @media (max-width: 900px) {
        .grid_3-col {
            grid-template-columns: repeat(2, 1fr);
        }
    }
    @media (max-width: 600px) {
        .grid_3-col {
            grid-template-columns: 1fr;
        }
    }
    .container {
        margin: 0 auto;
        max-width: 1280px;
    }
    .prose {
        color: var(--text-secondary, #4b5563) !important;
        max-width: none !important;
    }
    .prose h2 {
        color: var(--text-primary, #111827) !important;
        font-weight: 700 !important;
        font-size: 2rem !important;
    }
    .prose p {
        color: var(--text-secondary, #4b5563) !important;
        line-height: 1.75 !important;
    }
    .gs-reveal {
        opacity: 0;
        transform: translateY(20px);
    }
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        overflow: hidden;
        -webkit-line-clamp: 2;
    }

</style>
{% endblock %}