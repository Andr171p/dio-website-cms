    {% extends "base.html" %}
    {% load wagtailcore_tags wagtailimages_tags %}

    {% block content %}
    <article class="case-study font-sans">

        <!-- HERO -->
        <section class="section is-secondary hero relative min-h-[700px] flex items-center bg-cover bg-center bg-fixed"
                {% if page.main_image %}
                    style="background-image: url('{% image page.main_image fill-1920x1080 as hero_img %}{{ hero_img.url }}');"
                {% else %}
                    style="background: linear-gradient(135deg, #111827 0%, #1f2937 100%);"
                {% endif %}>
            <div class="absolute inset-0 bg-black/60"></div>
            <div class="container relative z-10">
                <div class="grid lg:grid-cols-2 gap-12 items-center">
                    <div class="text-white space-y-6 max-w-2xl">
                        <span class="inline-block px-4 py-2 bg-red-800 rounded-full text-sm font-bold tracking-wider">
                            {{ page.get_industry_display }}
                        </span>
                        <h1 class="text-5xl lg:text-6xl font-bold leading-tight">
                            {{ page.title }}
                        </h1>
                        {% if page.intro %}
                            <div class="text-lg lg:text-xl opacity-90 leading-relaxed">
                                {{ page.intro|richtext }}
                            </div>
                        {% endif %}
                        <a href="/cases" class="inline-flex items-center gap-2 text-red-400 hover:text-red-300 font-medium transition-colors">
                            Все кейсы
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- СЕКЦИИ -->
        {% for block in page.content %}
            {% cycle 'bg-gray-900' 'bg-gray-800/80' 'bg-gray-900/90' 'bg-gray-800/70' as bg_color silent %}
    {% cycle 'text-white' 'text-gray-100' as text_color silent %}

            <section class="section py-16 lg:py-24 {{ bg_color }}">
                <div class="container">

                    <!-- МАКЕТ 1: СЛЕВА ЗАГОЛОВОК, СПРАВА КОНТЕНТ -->
                    {% if block.block_type in "challenge solution technologies metrics" %}
                        <div class="grid lg:grid-cols-3 gap-12 items-start">
                            <h2 class="text-3xl lg:text-4xl font-bold {{ text_color }} leading-tight">
                                {% if block.block_type == "challenge" %}Задача
                                {% elif block.block_type == "solution" %}Решение
                                {% elif block.block_type == "technologies" %}Технологии
                                {% elif block.block_type == "metrics" %}Ключевые метрики{% endif %}
                            </h2>
                            <div class="lg:col-span-2">

                                <!-- ЗАДАЧА / РЕШЕНИЕ — RICHTEXT -->
                                {% if block.block_type in "challenge solution" %}
                                    <div class="rich-content {{ text_color }}">
                                        {{ block.value|richtext }}
                                    </div>

                                <!-- ТЕХНОЛОГИИ -->
                                {% elif block.block_type == "technologies" %}
                                    <ul class="space-y-4">
                                        {% for tech in block.value %}
                                            <li class="flex items-center gap-3 {{ text_color }}">
                                                <div class="w-3 h-3 bg-red-600 rounded-full flex-shrink-0"></div>
                                                <span class="text-lg font-medium">{{ tech }}</span>
                                            </li>
                                        {% endfor %}
                                    </ul>

                                <!-- МЕТРИКИ -->
                                {% elif block.block_type == "metrics" %}
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {% for m in block.value %}
                                            <div class="bg-black/30 backdrop-blur-sm p-6 rounded-xl border border-red-900/50 shadow-lg">
                                                <div class="text-3xl font-bold text-red-500">{{ m.value }}</div>
                                                <div class="text-sm {{ text_color }} opacity-80 mt-1">{{ m.description }}</div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% endif %}

                            </div>
                        </div>

                    <!-- МАКЕТ 2: ОПИСАНИЕ И РЕЗУЛЬТАТЫ — ЗАГОЛОВОК СВЕРХУ, КОНТЕНТ НИЖЕ -->
                    {% else %}
                        <div class="">
                            <h2 class="text-3xl lg:text-4xl font-bold {{ text_color }} mb-8 text-center lg:text-left">
                                {% if block.block_type == "description" %}Описание проекта
                                {% elif block.block_type == "results" %}Результаты{% endif %}
                            </h2>

                            <!-- ОПИСАНИЕ — ТЕКСТ + ФОТО МЕЖДУ АБЗАЦАМИ -->
                            {% if block.block_type == "description" %}
                                <div class="rich-content {{ text_color }}">
                                    {{ block.value|richtext }}
                                </div>

                            <!-- РЕЗУЛЬТАТЫ — БЛОКИ С ГАЛОЧКОЙ -->
                            {% elif block.block_type == "results" %}
                                <div class="results-blocks">
                                    {% for result in block.value %}
                                        <div class="result-block">
                                            <div class="icon">
                                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                </svg>
                                            </div>
                                            <div class="text">
                                                {{ result.text|richtext }}
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}

                </div>
            </section>
        {% endfor %}

        <!-- ДРУГИЕ КЕЙСЫ -->
        {% if other_cases %}
        <section class="section is-secondary py-20">
            <div class="container">
                <div class="flex justify-between items-center mb-12">
                    <h2 class="text-4xl font-bold text-white">Другие кейсы</h2>
                    <a href="/cases" class="text-red-500 hover:text-red-400 font-medium flex items-center gap-2 transition-colors">
                        Все кейсы
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% for case in other_cases %}
                        <a href="{{ case.url }}" class="group block relative h-96 rounded-2xl overflow-hidden shadow-xl transition-all duration-300 hover:scale-[1.02]">
                            {% if case.main_image %}
                                {% image case.main_image fill-800x600 as img %}
                                <img src="{{ img.url }}" alt="" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-700">
                            {% else %}
                                <div class="w-full h-full bg-gradient-to-br from-gray-700 to-gray-900"></div>
                            {% endif %}
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/30 to-transparent"></div>
                            <div class="absolute bottom-0 p-6 text-white">
                                <span class="inline-block px-3 py-1 bg-red-600/80 text-xs font-medium rounded-full mb-2">
                                    {{ case.get_industry_display }}
                                </span>
                                <h3 class="text-xl font-bold line-clamp-2 mb-1">{{ case.title }}</h3>
                                <p class="text-sm opacity-80 line-clamp-2">{{ case.intro|striptags|truncatewords:12 }}</p>
                            </div>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </section>
        {% endif %}

    </article>

    <style>
    /* === RICHTEXT — ОПИСАНИЕ (ФОТО МЕЖДУ ТЕКСТОМ) === */
    .rich-content {
        font-size: 1.125rem;
        line-height: 2;
        color: inherit;
    }
    .rich-content > * + * { margin-top: 1.5rem; }
    .rich-content p { margin-bottom: 1.5rem; }

    /* ФОТО — ПОТОКОВО, МЕЖДУ АБЗАЦАМИ */
    .rich-content img {
        display: block;
        width: 100%;
        height: auto;
        border-radius: 16px;
        border: 1px solid rgba(239,68,68,0.2);
    }

    /* СПИСКИ (для Задачи/Решения) */
    .rich-content ul {
        list-style: none;
        padding-left: 0;
        margin: 1.5rem 0;
    }
    .rich-content ul > li {
        position: relative;
        padding-left: 2.5rem;
        margin-bottom: 1.2rem;
        line-height: 1.8;
    }
    .rich-content ul > li::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0.75rem;
        width: 12px;
        height: 12px;
        border: 2px solid #ef4444;
        border-radius: 50%;
        background: transparent;
    }
    .rich-content ul.filled > li::before {
        background: #ef4444;
        border-color: #ef4444;
    }

    /* НУМЕРОВКА */
    .rich-content ol {
        counter-reset: list-item;
        list-style: none;
        padding-left: 0;
        margin: 1.5rem 0;
    }
    .rich-content ol > li {
        counter-increment: list-item;
        position: relative;
        padding-left: 2.5rem;
        margin-bottom: 1.2rem;
        line-height: 1.8;
    }
    .rich-content ol > li::before {
        content: counter(list-item) ".";
        position: absolute;
        left: 0;
        color: #ef4444;
        font-weight: bold;
        font-size: 1.1em;
    }

/* === РЕЗУЛЬТАТЫ — КВАДРАТНАЯ ГАЛОЧКА + ТЕКСТ ПОД НЕЙ === */
.results-blocks {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}
.result-block {
    background: rgba(31, 41, 55, 0.7);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(239, 68, 68, 0.4);
    border-radius: 16px;
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    transition: all 0.3s ease;
}
.result-block:hover {
    border-color: #ef4444;
    transform: translateY(-4px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.25);
}
.result-block .icon {
    width: 48px;
    height: 48px;
    border: 2px solid #ef4444;
    border-radius: 12px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    margin-bottom: 1rem;
}
.result-block .icon svg {
    width: 28px;
    height: 28px;
    color: #ef4444;
}
.result-block .text {
    flex: 1;
    line-height: 1.6;
    font-size: 1.1rem;
}
.result-block strong {
    color: #fca5a5;
    font-weight: 600;
}

.rich-content img {
    display: block;
    max-width: 100%;
    height: auto;
    margin: 2rem auto;
    border-radius: 16px;
    box-shadow: 0 15px 30px rgba(0,0,0,0.3);
    border: 1px solid rgba(239,68,68,0.2);
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    transform: translateZ(0);
}

    </style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для улучшения качества изображений
    function enhanceRichTextImages() {
        const images = document.querySelectorAll('.rich-content img');
        
        images.forEach(img => {
            const originalSrc = img.src;
            
            // Заменяем width-500 на width-1200
            if (originalSrc.includes('.width-500.')) {
                const enhancedSrc = originalSrc.replace('.width-500.', '.width-1200.');
                
                // Создаем новое изображение для предзагрузки
                const newImage = new Image();
                newImage.onload = function() {
                    // Если изображение загрузилось успешно, заменяем src
                    img.src = enhancedSrc;
                    console.log('Улучшено качество изображения:', enhancedSrc);
                };
                newImage.onerror = function() {
                    // Если width-1200 не существует, пробуем original
                    const fallbackSrc = originalSrc.replace('.width-500.', '.original.');
                    const fallbackImage = new Image();
                    
                    fallbackImage.onload = function() {
                        img.src = fallbackSrc;
                        console.log('Использовано оригинальное изображение:', fallbackSrc);
                    };
                    fallbackImage.onerror = function() {
                        console.log('Не удалось улучшить изображение:', originalSrc);
                    };
                    
                    fallbackImage.src = fallbackSrc;
                };
                
                newImage.src = enhancedSrc;
            }
        });
    }

    // Вызываем сразу после загрузки DOM
    enhanceRichTextImages();
    
    // Также вызываем при динамических изменениях (если есть SPA-функциональность)
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                enhanceRichTextImages();
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
});
</script>
    {% endblock %}