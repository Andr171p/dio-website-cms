{% load wagtailcore_tags wagtailimages_tags wagtailsettings_tags static %}

<header class="fixed top-0 w-full z-50 transition-all duration-300 bg-gradient-to-br from-gray-900 to-blue-800" id="header">
  <div class="container mx-auto px-6 py-4">
    <div class="flex items-center justify-between relative">
      <!-- Левая часть навигации -->
      <nav class="hidden lg:flex items-center space-x-8 relative flex-1 justify-start" id="desktop-menu-left">
        {% if settings.base.HeaderSettings.nav_items %}
          {% for item in settings.base.HeaderSettings.nav_items %}
            {% if forloop.counter0|divisibleby:2 %} {# Четные элементы слева #}
              <div class="relative group" data-menu-index="{{ forloop.counter0 }}">
                {% if item.value.page_link %}
                  <a href="{{ item.value.href|default:item.value.page_link.url|default:'#' }}" 
                     class="flex items-center text-white hover:text-blue-600 font-medium transition-colors duration-200 py-2 menu-item"
                     data-has-submenu="{% if item.value.submenu %}true{% else %}false{% endif %}">
                    {{ item.value.name }}
                    {% if item.value.submenu %}
                      <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                      </svg>
                    {% endif %}
                  </a>
                {% else %}
                  <a href="{{ item.value.href|default:'#' }}" 
                     class="flex items-center text-white hover:text-blue-600 font-medium transition-colors duration-200 py-2 menu-item"
                     data-has-submenu="{% if item.value.submenu %}true{% else %}false{% endif %}">
                    {{ item.value.name }}
                    {% if item.value.submenu %}
                      <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                      </svg>
                    {% endif %}
                  </a>
                {% endif %}
                
                <!-- Подменю -->
                {% if item.value.submenu %}
                  <div class="absolute top-full left-0 bg-white shadow-lg rounded-lg mt-2 py-2 w-48 z-50 submenu hidden group-hover:block">
                    {% for sub in item.value.submenu %}
                      <a href="{{ sub.href|default:sub.page_link.url|default:'#' }}" class="block px-4 py-2 text-black hover:bg-blue-50 hover:text-blue-600 rounded transition-colors duration-200">
                        {{ sub.name }}
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}
      </nav>

      <!-- Logo в центре -->
      {% get_settings use_default_site=True as settings %}
      <div class="absolute left-1/2 transform -translate-x-1/2 z-10">
        <a href="/" class="flex items-center space-x-3">
          {% if settings.base.HeaderSettings.logo %}
            {% image settings.base.HeaderSettings.logo width-254 height-928 as logo %}
            <div class="w-75 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center">
              <img src="{{ logo.url }}" alt="{{ settings.base.HeaderSettings.site_title|default:'Логотип сайта' }}" class="w-full h-full object-cover">
            </div>
          {% endif %}
          <div>
            {% if settings.base.HeaderSettings.site_title %}<h1 class="font-bold text-xl text-red-600">{{ settings.base.HeaderSettings.site_title }}</h1>{% endif %}
            {% if settings.base.HeaderSettings.site_subtitle %}<p class="text-sm text-red-600">{{ settings.base.HeaderSettings.site_subtitle }}</p>{% endif %}
          </div>
        </a>
      </div>

      <!-- Правая часть навигации -->
      <nav class="hidden lg:flex items-center space-x-8 relative flex-1 justify-end" id="desktop-menu-right">
        {% if settings.base.HeaderSettings.nav_items %}
          {% for item in settings.base.HeaderSettings.nav_items %}
            {% if not forloop.counter0|divisibleby:2 %} {# Нечетные элементы справа #}
              <div class="relative group" data-menu-index="{{ forloop.counter0 }}">
                {% if item.value.page_link %}
                  <a href="{{ item.value.href|default:item.value.page_link.url|default:'#' }}" 
                     class="flex items-center text-white hover:text-blue-600 font-medium transition-colors duration-200 py-2 menu-item"
                     data-has-submenu="{% if item.value.submenu %}true{% else %}false{% endif %}">
                    {{ item.value.name }}
                    {% if item.value.submenu %}
                      <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                      </svg>
                    {% endif %}
                  </a>
                {% else %}
                  <a href="{{ item.value.href|default:'#' }}" 
                     class="flex items-center text-white hover:text-blue-600 font-medium transition-colors duration-200 py-2 menu-item"
                     data-has-submenu="{% if item.value.submenu %}true{% else %}false{% endif %}">
                    {{ item.value.name }}
                    {% if item.value.submenu %}
                      <svg class="w-4 h-4 ml-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                      </svg>
                    {% endif %}
                  </a>
                {% endif %}
                
                <!-- Подменю -->
                {% if item.value.submenu %}
                  <div class="absolute top-full right-0 bg-white shadow-lg rounded-lg mt-2 py-2 w-48 z-50 submenu hidden group-hover:block">
                    {% for sub in item.value.submenu %}
                      <a href="{{ sub.href|default:sub.page_link.url|default:'#' }}" class="block px-4 py-2 text-black hover:bg-blue-50 hover:text-blue-600 rounded transition-colors duration-200">
                        {{ sub.name }}
                      </a>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        {% endif %}

        <!-- CTA Button -->
        {% if settings.base.HeaderSettings.consultation_button_text %}
          <a href="#contact" class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white px-6 py-2 rounded-lg font-medium transition-all duration-200">
            {{ settings.base.HeaderSettings.consultation_button_text }}
          </a>
        {% endif %}
      </nav>

      <!-- Mobile Menu Button -->
      <button class="lg:hidden text-white transition-colors duration-200 hover:text-blue-600" onclick="toggleMobileMenu()">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
        <span class="sr-only">Toggle menu</span>
      </button>
    </div>

    <!-- Mobile Menu -->
    <div id="mobile-menu" class="lg:hidden mt-4 pb-4 border-t border-gray-200 hidden">
      <nav class="flex flex-col space-y-3 pt-4">
        {% if settings.base.HeaderSettings.nav_items %}
          {% for item in settings.base.HeaderSettings.nav_items %}
            <div>
              {% if item.value.page_link %}
                <a href="{{ item.value.href|default:item.value.page_link.url|default:'#' }}" class="text-white hover:text-blue-600 font-medium text-left py-2 block">
                  {{ item.value.name }}
                </a>
              {% else %}
                <a href="{{ item.value.href|default:'#' }}" class="text-white hover:text-blue-600 font-medium text-left py-2 block">
                  {{ item.value.name }}
                </a>
              {% endif %}
              {% if item.value.submenu %}
                <div class="pl-4 mt-2 space-y-2">
                  {% for sub in item.value.submenu %}
                    <a href="{{ sub.href|default:sub.page_link.url|default:'#' }}" class="block text-white hover:text-blue-600 hover:bg-blue-900 py-2 px-3 rounded transition-colors duration-200">
                      {{ sub.name }}
                    </a>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        {% endif %}
        {% if settings.base.HeaderSettings.phone_number %}
          <div class="flex items-center space-x-2 py-2 text-white">
            <span class="font-semibold">{{ settings.base.HeaderSettings.phone_number }}</span>
          </div>
        {% endif %}
        {% if settings.base.HeaderSettings.consultation_button_text %}
          <a href="#contact" class="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-700 hover:to-blue-900 text-white px-6 py-3 rounded-lg font-medium mt-2 flex items-center justify-center space-x-2">
            <span>{{ settings.base.HeaderSettings.consultation_button_text }}</span>
          </a>
        {% endif %}
      </nav>
    </div>
  </div>
</header>

<!-- JavaScript для функциональности -->
<script>
let openSubmenu = null;
let closeTimeout = null;
const menuContainer = document.getElementById('desktop-menu-left') || document.getElementById('desktop-menu-right');

// Закрытие при клике вне меню
document.addEventListener('mousedown', (event) => {
  if (menuContainer && !menuContainer.contains(event.target)) {
    closeAllSubmenus();
  }
});

function setupMenuHover() {
  const menuItems = document.querySelectorAll('.menu-item');
  
  menuItems.forEach((menuItem, index) => {
    const hasSubmenu = menuItem.getAttribute('data-has-submenu') === 'true';
    
    if (hasSubmenu) {
      const menuItemContainer = menuItem.closest('.relative');
      
      menuItemContainer.addEventListener('mouseenter', () => {
        if (closeTimeout) clearTimeout(closeTimeout);
        closeAllSubmenus();
        openSubmenu = index;
        const submenu = menuItemContainer.querySelector('.submenu');
        if (submenu) {
          submenu.classList.remove('hidden');
        }
      });
      
      menuItemContainer.addEventListener('mouseleave', () => {
        closeTimeout = setTimeout(() => {
          closeAllSubmenus();
        }, 200);
      });
    }
  });
}

function closeAllSubmenus() {
  const submenus = document.querySelectorAll('.submenu');
  submenus.forEach(submenu => {
    submenu.classList.add('hidden');
  });
  openSubmenu = null;
}

function toggleMobileMenu() {
  const mobileMenu = document.getElementById('mobile-menu');
  mobileMenu.classList.toggle('hidden');
}

function closeMobileMenu() {
  const mobileMenu = document.getElementById('mobile-menu');
  mobileMenu.classList.add('hidden');
}

// Динамическая проверка скролла
document.addEventListener('DOMContentLoaded', function() {
  setupMenuHover();
  
  const header = document.getElementById('header');
  window.addEventListener('scroll', function() {
    if (window.scrollY > 50) {
      header.classList.add('bg-white/95', 'backdrop-blur-md', 'shadow-lg');
    } else {
      header.classList.remove('bg-white/95', 'backdrop-blur-md', 'shadow-lg');
    }
  });
});
</script>