{% load wagtailcore_tags wagtailimages_tags wagtailsettings_tags static %}

<!-- Основной хедер навигации -->
<nav class="main-nav">
  <div class="main-nav__container">
    <!-- Логотип -->
    <div class="main-nav__brand">
      <a href="/" class="brand-link">
        {% get_settings use_default_site=True as settings %}
        {% if settings.base.HeaderSettings.logo %}
          {% image settings.base.HeaderSettings.logo width-80 height-80 as logo %}
          <div class="brand-logo">
            <img
              src="{{ logo.url }}"
              alt="{{ settings.base.HeaderSettings.site_title|default:'Логотип сайта' }}"
              class="brand-logo__image"
            >
          </div>
        {% else %}
          <div class="brand-logo">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="currentColor">
              <path d="M16 0C7.164 0 0 7.164 0 16s7.164 16 16 16 16-7.164 16-16S24.836 0 16 0zm0 28C9.373 28 4 22.627 4 16S9.373 4 16 4s12 5.373 12 12-5.373 12-12 12z"/>
              <path d="M16 8c-4.418 0-8 3.582-8 8s3.582 8 8 8 8-3.582 8-8-3.582-8-8-8zm0 12c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z"/>
            </svg>
          </div>
        {% endif %}
        <span class="heading_h3 brand-name">{{ settings.base.HeaderSettings.site_title }}</span>
      </a>
    </div>

    <!-- Навигация -->
    <div class="main-nav__menu  ">
      <ul class="nav-list">
        {% for item in settings.base.HeaderSettings.nav_items %}
          <li class="nav-item {% if item.value.menu_type != 'none' %}nav-item--dropdown{% endif %}">
            {% if item.value.menu_type == "none" %}
              <a
                href="{% if item.value.page %}{{ item.value.page.url }}{% else %}{{ item.value.external_url|default:'#' }}{% endif %}"
                class="nav-link heading_h4"
              >
                {{ item.value.name }}
              </a>
            {% else %}
              <div class="dropdown">
                <!-- Кликабельная ссылка для родительского пункта -->
                <a 
                  href="{% if item.value.page %}{{ item.value.page.url }}{% else %}{{ item.value.external_url|default:'#' }}{% endif %}"
                  class="dropdown__toggle-link heading_h4"
                >
                  {{ item.value.name }}
                </a>
                <button class="dropdown__toggle" aria-expanded="false">
                  <svg class="dropdown__chevron" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M4 6l4 4 4-4"/>
                  </svg>
                </button>
                
                {% if item.value.menu_type == "simple" %}
                  <div class="dropdown__menu heading_h4">
                    <div class="dropdown__content">
                      {% for subitem in item.value.simple_dropdown_items %}
                        <a
                          href="{% if subitem.page %}{{ subitem.page.url }}{% else %}{{ subitem.external_url|default:'#' }}{% endif %}"
                          class="dropdown__link"
                        >
                          {{ subitem.name }}
                        </a>
                      {% endfor %}
                    </div>
                  </div>
                {% elif item.value.menu_type == "grouped" %}
                  <div class="dropdown__menu dropdown__menu--mega heading_h4 ">
                    <div class="dropdown__content">
                      <div class="mega-grid">
                        {% for group in item.value.dropdown_groups %}
                          <div class="mega-group">
                            <h4 class="mega-group__title">{{ group.group_title }}</h4>
                            <div class="mega-group__items">
                              {% for subitem in group.value.items %}
                                <a
                                  href="{% if subitem.value.page %}{{ subitem.value.page.url }}{% else %}{{ subitem.value.external_url|default:'#' }}{% endif %}"
                                  class="mega-item"
                                >
                                  <div class="mega-item__icon">
                                    {% if subitem.value.icon_svg %}
                                      {{ subitem.value.icon_svg|safe }}
                                    {% else %}
                                      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                        <circle cx="10" cy="10" r="3"/>
                                      </svg>
                                    {% endif %}
                                  </div>
                                  <div class="mega-item__content">
                                    <div class="mega-item__title">{{ subitem.value.name }}</div>
                                    {% if subitem.value.description %}
                                      <div class="mega-item__desc">{{ subitem.value.description }}</div>
                                    {% endif %}
                                  </div>
                                </a>
                              {% endfor %}
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Кнопка CTA -->
    <div class="main-nav__actions">
      <button 
        onclick="document.getElementById('contact-section')?.scrollIntoView({ behavior: 'smooth' });"
        class="button"
      >
        {{ settings.base.HeaderSettings.consultation_button_text }}
      </button>
    </div>

    <!-- Мобильное меню -->
    <button class="mobile-menu-toggle" aria-label="Открыть меню">
      <span></span>
      <span></span>
      <span></span>
    </button>

    <!-- Мобильная навигация -->
    <div class="mobile-nav heading_h3">
      <div class="mobile-nav__header">
        <div class="mobile-nav__brand">
          <a href="/" class="brand-link">
            {% if settings.base.HeaderSettings.logo %}
              {% image settings.base.HeaderSettings.logo width-40 height-40 as logo %}
              <div class="brand-logo">
                <img src="{{ logo.url }}" alt="{{ settings.base.HeaderSettings.site_title }}" class="brand-logo__image">
              </div>
            {% endif %}
            <span class="brand-name">{{ settings.base.HeaderSettings.site_title }}</span>
          </a>
        </div>
        <button class="mobile-nav__close" aria-label="Закрыть меню">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="mobile-nav__content">
        <ul class="mobile-nav__list">
          {% for item in settings.base.HeaderSettings.nav_items %}
            <li class="mobile-nav__item">
              {% if item.value.menu_type == "none" %}
                <a
                  href="{% if item.value.page %}{{ item.value.page.url }}{% else %}{{ item.value.external_url|default:'#' }}{% endif %}"
                  class="mobile-nav__link"
                  onclick="closeMobileMenu()"
                >
                  {{ item.value.name }}
                </a>
              {% else %}
                <div class="mobile-nav__dropdown">
                  <div class="mobile-nav__link-container">
                    <a
                      href="{% if item.value.page %}{{ item.value.page.url }}{% else %}{{ item.value.external_url|default:'#' }}{% endif %}"
                      class="mobile-nav__link"
                      onclick="closeMobileMenu()"
                    >
                      {{ item.value.name }}
                    </a>
                    <button class="mobile-nav__dropdown-toggle" aria-expanded="false" onclick="toggleMobileDropdown(this)">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                        <path d="M4 6l4 4 4-4"/>
                      </svg>
                    </button>
                  </div>
                  <div class="mobile-nav__dropdown-content">
                    {% if item.value.menu_type == "simple" %}
                      {% for subitem in item.value.simple_dropdown_items %}
                        <a
                          href="{% if subitem.page %}{{ subitem.page.url }}{% else %}{{ subitem.external_url|default:'#' }}{% endif %}"
                          class="mobile-nav__sublink"
                          onclick="closeMobileMenu()"
                        >
                          {{ subitem.name }}
                        </a>
                      {% endfor %}
                    {% elif item.value.menu_type == "grouped" %}
                      {% for group in item.value.dropdown_groups %}
                        <div class="mobile-nav__group">
                          <div class="mobile-nav__group-title">{{ group.group_title }}</div>
                          {% for subitem in group.value.items %}
                            <a
                              href="{% if subitem.value.page %}{{ subitem.value.page.url }}{% else %}{{ subitem.value.external_url|default:'#' }}{% endif %}"
                              class="mobile-nav__sublink"
                              onclick="closeMobileMenu()"
                            >
                              {{ subitem.value.name }}
                            </a>
                          {% endfor %}
                        </div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
        <div class="mobile-nav__actions">
          <button 
            onclick="closeMobileMenu(); document.getElementById('contact-section')?.scrollIntoView({ behavior: 'smooth' });"
            class="button button--full"
          >
            {{ settings.base.HeaderSettings.consultation_button_text }}
          </button>
        </div>
      </div>
    </div>
  </div>
</nav>

<style>

/* Отступ для контента под фиксированным хедером */
body {
  padding-top: 70px;
}

/* Предотвращение скролла при открытом мобильном меню */
body.no-scroll {
  overflow: hidden;
}
</style>

<script>
// Глобальные функции для работы мобильного меню
function openMobileMenu() {
  const mobileNav = document.querySelector('.mobile-nav');
  const body = document.body;
  if (mobileNav) {
    mobileNav.classList.add('is-open');
    body.classList.add('no-scroll');
  }
}

function closeMobileMenu() {
  const mobileNav = document.querySelector('.mobile-nav');
  const body = document.body;
  if (mobileNav) {
    mobileNav.classList.remove('is-open');
    body.classList.remove('no-scroll');
    
    // Закрываем все выпадающие меню
    const dropdownContents = document.querySelectorAll('.mobile-nav__dropdown-content');
    const dropdownToggles = document.querySelectorAll('.mobile-nav__dropdown-toggle');
    
    dropdownContents.forEach(content => content.classList.remove('is-open'));
    dropdownToggles.forEach(toggle => toggle.classList.remove('is-open'));
  }
}

function toggleMobileDropdown(button) {
  // Предотвращаем всплытие события, чтобы не срабатывал клик по ссылке
  event.stopPropagation();
  
  const dropdownContent = button.parentElement.nextElementSibling;
  const isOpen = dropdownContent.classList.contains('is-open');
  
  // Закрываем все другие открытые dropdown
  const allDropdowns = document.querySelectorAll('.mobile-nav__dropdown-content');
  const allToggles = document.querySelectorAll('.mobile-nav__dropdown-toggle');
  
  allDropdowns.forEach(dropdown => dropdown.classList.remove('is-open'));
  allToggles.forEach(toggle => toggle.classList.remove('is-open'));
  
  // Открываем/закрываем текущий dropdown
  if (!isOpen) {
    dropdownContent.classList.add('is-open');
    button.classList.add('is-open');
  }
}

// Инициализация при загрузке DOM
document.addEventListener('DOMContentLoaded', function() {
  // Мобильное меню - открытие
  const mobileToggle = document.querySelector('.mobile-menu-toggle');
  if (mobileToggle) {
    mobileToggle.addEventListener('click', openMobileMenu);
  }
  
  // Мобильное меню - закрытие
  const mobileClose = document.querySelector('.mobile-nav__close');
  if (mobileClose) {
    mobileClose.addEventListener('click', closeMobileMenu);
  }
  
  // Закрытие мобильного меню при клике на ссылки (уже обрабатывается в onclick)
  
  // Закрытие мобильного меню при клике вне контента
  const mobileNav = document.querySelector('.mobile-nav');
  if (mobileNav) {
    mobileNav.addEventListener('click', function(e) {
      if (e.target === mobileNav) {
        closeMobileMenu();
      }
    });
  }
});

// Резервная инициализация если DOM уже загружен
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMobileMenu);
} else {
  initMobileMenu();
}

function initMobileMenu() {
  // Функции уже объявлены глобально, просто проверяем элементы
  console.log('Mobile menu initialized');
}
</script>