{% load wagtailcore_tags wagtailimages_tags static %}

<!-- Ваш существующий код -->
<div class="assistant-wrapper" id="assistantWrapper">
    <button class="assistant-toggle" id="assistantToggle" onclick="toggleAssistant()">
        <svg xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="50" height="50" viewBox="0 0 50 50"
style="fill:#FFFFFF;">
<path d="M 25 4.5 C 15.204 4.5 5.9439688 11.985969 3.9179688 21.542969 C 3.9119687 21.571969 3.9200156 21.599906 3.9160156 21.628906 C 1.5620156 23.233906 -0.04296875 26.383 -0.04296875 30 C -0.04296875 35.238 3.3210312 39.5 7.4570312 39.5 C 7.7850313 39.5 8.0913438 39.339313 8.2773438 39.070312 C 8.4643437 38.800312 8.5065781 38.456438 8.3925781 38.148438 C 8.3775781 38.110438 6.9550781 34.244 6.9550781 29.5 C 6.9550781 24.506 8.3091719 22.022187 8.3261719 21.992188 C 8.5011719 21.683187 8.4983125 21.305047 8.3203125 20.998047 C 8.1433125 20.689047 7.8130313 20.5 7.4570312 20.5 C 7.0350313 20.5 6.62275 20.554625 6.21875 20.640625 C 8.58675 12.613625 16.57 6.5 25 6.5 C 32.992 6.5 40.688641 12.044172 43.431641 19.576172 C 43.133641 19.530172 42.831438 19.5 42.523438 19.5 C 42.169438 19.5 41.841109 19.689094 41.662109 19.996094 C 41.482109 20.302094 41.481297 20.683187 41.654297 20.992188 C 41.668297 21.016188 43.023437 23.5 43.023438 28.5 C 43.023438 32.44 42.045078 35.767641 41.705078 36.806641 C 40.558078 37.740641 38.815344 39.034297 36.777344 40.154297 C 36.016344 39.305297 34.839391 38.871437 33.650391 39.148438 L 31.867188 39.560547 C 31.024188 39.753547 30.308609 40.262094 29.849609 40.996094 C 29.391609 41.728094 29.245453 42.598453 29.439453 43.439453 C 29.783453 44.935453 31.11975 45.949219 32.59375 45.949219 C 32.83275 45.949219 33.074359 45.923188 33.318359 45.867188 L 35.103516 45.457031 C 35.945516 45.264031 36.661141 44.752531 37.119141 44.019531 C 37.503141 43.406531 37.653984 42.700187 37.583984 41.992188 C 39.728984 40.830188 41.570453 39.483422 42.814453 38.482422 C 46.814453 38.286422 50.023438 34.114 50.023438 29 C 50.023438 25.237 48.284437 21.989172 45.773438 20.451172 C 45.769438 20.376172 45.777859 20.301563 45.755859 20.226562 C 43.152859 11.113563 34.423 4.5 25 4.5 z M 12 19 C 11.447 19 11 19.447 11 20 L 11 32 C 11 32.553 11.447 33 12 33 L 28.044922 33 C 27.540922 34.057 26.743578 35.482375 26.142578 36.484375 C 25.941578 36.819375 25.954828 37.2405 26.173828 37.5625 C 26.360828 37.8395 26.673 38 27 38 C 27.055 38 27.109063 37.995328 27.164062 37.986328 C 33.351062 36.955328 38.412 32.95125 38.625 32.78125 C 38.862 32.59125 39 32.304 39 32 L 39 20 C 39 19.447 38.553 19 38 19 L 12 19 z M 18.5 23 C 19.902 23 21 24.317 21 26 C 21 27.683 19.902 29 18.5 29 C 17.098 29 16 27.683 16 26 C 16 24.317 17.098 23 18.5 23 z M 31.5 23 C 32.902 23 34 24.317 34 26 C 34 27.683 32.902 29 31.5 29 C 30.098 29 29 27.683 29 26 C 29 24.317 30.098 23 31.5 23 z"></path>
</svg>
</svg>
    </button>
    <div class="assistant-panel" id="aiAssistant">
        <div class="assistant-header">
            <h2 class="heading_h4 text-center">AI Ассистент</h2>
            <p class="paragraph_large text-color_secondary text-center margin-bottom_large">
                Задайте вопрос и получите мгновенную помощь!
            </p>
        </div>
        <div class="assistant-body" id="assistantBody">
            <div class="assistant-messages" id="assistantMessages">
                <div class="message bot-message">Привет! Я ваш AI-ассистент. Задайте мне вопрос!</div>
            </div>
            <div class="assistant-input-container w-form">
                <input type="text" id="assistantInput" class="input_field w-input" placeholder="Введите сообщение...">
                <button class="button w-button" id="assistantSend">Отправить</button>
            </div>
        </div>
    </div>
</div>

<!-- Ваш остальной код -->
<style>
.assistant-wrapper {
    position: fixed;
    bottom: 40px;
    right: 40px;
    z-index: 1000;
}

.assistant-toggle {
    width: 60px;
    height: 60px;
    background: #920707;
    border: none;
    border-radius: 50%;
    color: #ffffff;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.3s ease, background 0.3s ease;
}

.assistant-toggle:hover {
    background: #cc0a0a;
    transform: scale(1.1);
}

.assistant-panel {
    width: 350px;
    background: #ffffff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    position: absolute;
    right: 0;
    bottom: 70px;
    transform: translateX(100%);
    transition: transform 0.3s ease, display 0s;
    overflow: hidden;
    display: none; /* Скрыт по умолчанию */
}

.assistant-panel.active {
    transform: translateX(0);
    display: block; /* Показывается при активации */
}

.assistant-header {
    margin-bottom: 20px;
}

.assistant-body {
    max-height: 400px;
    overflow-y: auto;
    margin-bottom: 20px;
}

.assistant-messages {
    display: flex;
    flex-direction: column;
    gap: 15px;
    max-height: 250px;
    overflow-y: auto;
    padding-right: 5px;
}

.message {
    margin: 10px 0;
    padding: 12px;
    border-radius: 8px;
    max-width: 80%;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    line-height: 1.5;
    word-break: break-word;
    animation: slideIn 0.3s ease;
}

.bot-message {
    background: #f8f9fa;
    color: #333;
    align-self: flex-start;
}

.user-message {
    background: #1a2b3b;
    color: #ffffff;
    align-self: flex-end;
}

.assistant-input-container {
    padding: 12px;
    display: flex;
    gap: 15px;
    align-items: center;
}

.assistant-input-container .input_field {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    box-sizing: border-box;
    color: #000000;
}

.assistant-input-container .button {
    padding: 10px 20px;
    background: #1a2b3b;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: background 0.3s ease;
}

.assistant-input-container .button:hover {
    background: #0056b3;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateX(-20px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@media (max-width: 767px) {
    .assistant-panel {
        width: 90%;
        right: 5%;
    }
    .assistant-body {
        max-height: 300px;
    }
    .assistant-messages {
        max-height: 250px;
    }
}

/* Стили для скроллбара */
.assistant-messages::-webkit-scrollbar {
    width: 6px;
}

.assistant-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.assistant-messages::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.assistant-messages::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<!-- Подключение JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const assistantToggle = document.getElementById('assistantToggle');
    const assistantPanel = document.getElementById('aiAssistant');
    const assistantMessages = document.getElementById('assistantMessages');
    const assistantInput = document.getElementById('assistantInput');
    const assistantSend = document.getElementById('assistantSend');

    if (!assistantToggle || !assistantPanel || !assistantMessages || !assistantInput || !assistantSend) {
        console.error('One or more assistant elements not found:', {
            assistantToggle: !!assistantToggle,
            assistantPanel: !!assistantPanel,
            assistantMessages: !!assistantMessages,
            assistantInput: !!assistantInput,
            assistantSend: !!assistantSend
        });
        return;
    }

    // Функция для плавной прокрутки к последнему сообщению
    function scrollToBottom() {
        if (assistantMessages) {
            assistantMessages.scrollTop = assistantMessages.scrollHeight;
            setTimeout(() => {
                assistantMessages.scrollTop = assistantMessages.scrollHeight;
            }, 50);
        }
    }

    // Переключение чата
    function toggleAssistant() {
        assistantPanel.classList.toggle('active');
        if (assistantPanel.classList.contains('active')) {
            setTimeout(scrollToBottom, 300);
        }
    }

    // Эмуляция эффекта печати текста
    function typeEffect(element, text, delay = 50) {
        let index = 0;
        element.textContent = '';
        function typeChar() {
            if (index < text.length) {
                element.textContent += text[index];
                index++;
                setTimeout(typeChar, delay);
            }
        }
        typeChar();
    }

    // Отправка сообщения к API
    async function sendAssistantMessage() {
        const messageText = assistantInput.value.trim();
        if (!messageText) return;

        assistantInput.value = '';

        const userMessage = document.createElement('div');
        userMessage.className = 'message user-message';
        userMessage.textContent = messageText;
        assistantMessages.appendChild(userMessage);
        scrollToBottom();

        // Добавляем временное сообщение "Печатает..."
        const typingMessage = document.createElement('div');
        typingMessage.className = 'message bot-message typing-message';
        typingMessage.textContent = 'Печатает...';
        assistantMessages.appendChild(typingMessage);
        scrollToBottom();

        try {
            const response = await fetch('http://localhost:8001/api/v1/rag', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify({ chat_id: '1', role: 'user', text: messageText })
            });
            if (!response.ok) throw new Error('Ошибка сети');
            const data = await response.json();

            // Удаляем "Печатает..." и добавляем реальный ответ
            assistantMessages.removeChild(typingMessage);
            const botMessage = document.createElement('div');
            botMessage.className = 'message bot-message';
            assistantMessages.appendChild(botMessage);
            typeEffect(botMessage, data.text);
            scrollToBottom();
        } catch (error) {
            console.error('Ошибка:', error);
            assistantMessages.removeChild(typingMessage);
            const errorMessage = document.createElement('div');
            errorMessage.className = 'message bot-message';
            errorMessage.textContent = 'Ошибка при получении ответа.';
            assistantMessages.appendChild(errorMessage);
            scrollToBottom();
        }
    }

    // Инициализация при загрузке
    scrollToBottom();

    // Назначаем обработчики событий
    assistantToggle.addEventListener('click', toggleAssistant);
    assistantSend.addEventListener('click', sendAssistantMessage);
    assistantInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') sendAssistantMessage();
    });

    // Наблюдатель за изменениями в сообщениях
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.addedNodes.length) {
                setTimeout(scrollToBottom, 10);
            }
        });
    });

    observer.observe(assistantMessages, { childList: true, subtree: true });

    // Закрытие чата при клике вне панели
    document.addEventListener('click', function(event) {
        const isClickInside = assistantPanel.contains(event.target);
        const isToggleClick = assistantToggle.contains(event.target);
        if (assistantPanel.classList.contains('active') && !isClickInside && !isToggleClick) {
            assistantPanel.classList.remove('active');
        }
    });
});
</script>